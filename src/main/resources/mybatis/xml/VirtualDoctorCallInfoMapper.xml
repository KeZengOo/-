<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.VirtualDoctorCallInfoMapper">

	<select id="getCallVisitCount" resultType="java.lang.Integer">
		SELECT 
			count(*)
		FROM virtual_doctor_call_info v
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
	    WHERE  v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )
	</select>
	
	<select id="getCallVisitList" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.CallVisitBean">
		SELECT 
			v.id AS callId, call_time AS callTime,v.visit_channel visitChannel, v.status_name AS statusName, call_url AS callUrl, v.type,
			date_format(v.create_time, '%Y-%m-%d %H:%i:%S') AS createTime,
			remark,du.name AS drugUserName 
		FROM virtual_doctor_call_info v
		<!-- START  -->
		JOIN drug_user du
		ON v.virtual_drug_user_id = du.id
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
		<!-- END -->
	    WHERE  v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )
		
		ORDER BY createTime DESC
		LIMIT #{currentSize}, #{pageSize}
	</select>

	<insert id="saveVirtualDoctorCallInfo" keyProperty="callId" useGeneratedKeys="true"
		parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		INSERT INTO virtual_doctor_call_info
		(sin_token, virtual_doctor_id, mobile, type, status, status_name, create_time, call_url, call_time)
		VALUES
		(#{sinToken}, #{virtualDoctorId}, #{mobile}, #{type}, #{status}, #{statusName}, #{visitTime}, #{callUrl}, #{callTime})
	</insert>
	
	<update id="updateVirtualDoctorCallInfo" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		UPDATE virtual_doctor_call_info 
		<set>
			<if test="productId != null and productId>0">
				product_id = #{productId} ,
			</if>
			<if test="doctorQuestionnaireId != null and doctorQuestionnaireId > 0">
				doctor_questionnaire_id=#{doctorQuestionnaireId},
			</if>
			<if test="callUrl != null and callUrl !=''">
				call_url=#{callUrl},
			</if>

			<if test="statusName !=null and statusName !=''">
				status_name=#{statusName},
			</if>

			<if test="status != null">
				status=#{status},
			</if>
			<if test="remark != null and remark !=''">
				remark=#{remark}
			</if>
		</set>
		WHERE id=#{callId}
	</update>

	<select id="geTelephoneDoctorVisitCount" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.StatisticsDrugNumResponse">
		<!-- 2018-09-29 修改前
		SELECT
		virtual_drug_user_id drugUserId,count(DISTINCT virtual_doctor_id) total
		FROM virtual_doctor_call_info
		WHERE
		virtual_drug_user_id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		<if test="startTime!=null">
			and date_format(create_time,'%Y-%m-%d')&gt;=#{startTime}
		</if>
		<if test="endTime!=null">
			and date_format(create_time,'%Y-%m-%d')&lt;=#{endTime}
		</if>
		AND product_id=#{productId}
		GROUP BY virtual_drug_user_id
		-->

		<!-- 2018-09-29 重构后 -->
		SELECT
		call_dud.drugUserId,
		COUNT(
		DISTINCT vdci.virtual_doctor_id
		) total
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		WHERE
		vdci.product_id
		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>
		GROUP BY
		call_dud.drugUserId

	</select>


	<!-- 医生拜访数：医生ID列表 -->
	<select id="geTelephoneDoctorVisitDoctorIdList" resultType="java.lang.Long">

		SELECT
		DISTINCT vdci.virtual_doctor_id
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		WHERE
		vdci.product_id
		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>

		<if test="self != null and self==1">
			AND vdci.virtual_drug_user_id IN
			<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>


	</select>


	<!-- 医生拜访数(拜访结果为（类型=接触医生）)：医生ID列表 -->
	<select id="getDoctorVisitContactDoctorIdList" resultType="java.lang.Long">

		SELECT
		DISTINCT vdci.virtual_doctor_id
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		INNER JOIN virtual_doctor_call_info_mend m
		ON vdci.id=m.call_id
		INNER JOIN virtual_doctor_call_info_result r
		ON m.id=r.mend_id
		INNER JOIN virtual_product_visit_result re
		ON r.result_id=re.id
		WHERE
		vdci.product_id=#{productId}
		<if test="visitResultType!=null and visitResultType!=0">
			AND re.visit_type LIKE CONCAT('%',#{visitResultType}, '%')
		</if>

		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(vdci.create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(vdci.create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>

		<if test="self!=null and self==1">
			AND vdci.virtual_drug_user_id IN
			<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

	</select>


	<!-- 更新打电话的医生ID -->
	<update id="updateCallInfoDoctorId">
		UPDATE virtual_doctor_call_info SET virtual_doctor_id=#{doctorId}
		WHERE mobile IN
		<foreach collection="telephoneList" item="telephone" open="(" close=")" separator=",">
			#{telephone}
		</foreach>
		AND virtual_doctor_id IS NULL
	</update>


	<!-- 保存电话记录 -->
	<insert id="saveCallInfo" keyProperty="id" useGeneratedKeys="true" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.CallRequestBean">
		INSERT INTO virtual_doctor_call_info(sin_token,visit_channel, virtual_doctor_id, mobile, virtual_drug_user_id, status, status_name, call_time, call_url, type, product_id)
		VALUES
		(#{sinToken},#{visitChannel}, #{doctorId}, #{mobile}, #{drugUserId}, #{status}, #{statusName}, #{times}, #{url}, #{type}, #{productId})
	</insert>


	<!-- 得到医生电话以及接通次数 -->
	<select id="getTelephoneCallCount" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CallTelephoneReponseBean">
		SELECT * FROM (
		SELECT t.telephone,
		(SELECT COUNT(*) FROM virtual_doctor_call_info WHERE mobile=t.telephone AND status_name = 'answer') callCount
		 FROM (

		SELECT
							telephone
						FROM
							doctor
						WHERE
							id = #{doctorId}
						AND LEFT (telephone, 1) = 1
						UNION
							SELECT
								telephone
							FROM
								doctor_telephone
							WHERE
								doctor_id = #{doctorId}

		) t
		) a ORDER BY a.callCount DESC


	</select>


	<!-- 得到医生电话以及接通次数 -->
	<select id="getAllTelephoneCallCount" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CallTelephoneReponseBean">
		SELECT * FROM (
		SELECT t.telephone,t.doctorId,
		(SELECT COUNT(*) FROM virtual_doctor_call_info WHERE mobile=t.telephone AND status_name = 'answer') callCount
		 FROM (

		SELECT
							telephone, id doctorId
						FROM
							doctor
						WHERE
							id IN
						<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
							#{doctorId}
						</foreach>


						AND LEFT (telephone, 1) = 1
						UNION
							SELECT
								telephone, doctor_id doctorId
							FROM
								doctor_telephone
							WHERE
								doctor_id IN
							<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
								#{doctorId}
							</foreach>


		) t
		) a


	</select>




	<update id="updateCallProduct">
		UPDATE virtual_doctor_call_info SET product_id=#{productId}
		WHERE id = #{callId}
	</update>


	<!-- 更新录音文本 -->
	<insert id="updateCallUrlText">
		REPLACE INTO virtual_doctor_call_text(sin_token, call_text) VALUES(#{sinToken}, #{callText})
	</insert>


	<!-- 临时功能 -->
	<select id="getVisitHistoryList" resultType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean">
		SELECT
			doctor_id doctorId,
			old_drug_user_id drugUserId,
			mobile,
			visit_channel visitChannel,
			visit_time visitTime,
			remark,
			150 productId,
			UUID() sinToken,
			visit_result visitResult,
			attitude,
			have_drug haveDrug,
			recruit,
			have_ae haveAe,
			is_target target


		FROM
			a_ahistory_sfl
		WHERE
			doctor_id IS NOT NULL
		AND doctor_id != 0
	</select>

	<insert id="insertVisitHistory" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean"
			keyProperty="callId" useGeneratedKeys="true">
		INSERT INTO virtual_doctor_call_info(sin_token, virtual_doctor_id,virtual_drug_user_id, mobile, visit_channel, create_time, remark, product_id)
		VALUES (#{sinToken}, #{doctorId}, #{drugUserId}, #{mobile}, #{visitChannel}, #{visitTime}, #{remark}, #{productId})
	</insert>


	<insert id="insertVisitHistoryMend" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean"
			keyProperty="mendId" useGeneratedKeys="true">
		INSERT INTO virtual_doctor_call_info_mend(virtual_drug_user_id, virtual_doctor_id, product_id, call_id, attitude, hcp_potential, is_break_off, is_has_ae, is_target, is_has_drug, is_recruit, recruit_time)
		VALUES (#{drugUserId}, #{doctorId}, #{productId}, #{callId}, #{attitude}, -1, 0, #{haveAe}, #{target}, #{haveDrug}, #{recruit}, #{visitTime})
	</insert>

	<insert id="insertVisitHistoryMendResult" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean">
		INSERT INTO virtual_doctor_call_info_result(mend_id, result_id)
		VALUES(#{mendId},#{visitResult})
	</insert>

	<!-- 查询指定日期的计划拜访人数 -->
	<select id="getVisitCountList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.VisitCountResponseBean">
		SELECT
			COUNT(
				DISTINCT vdcim.virtual_doctor_id
			) as count,
			DATE_FORMAT(next_visit_time, '%Y-%m-%d') date
		FROM
			virtual_doctor_call_info_mend vdcim
		INNER JOIN doctor d ON vdcim.virtual_doctor_id = d.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		AND dud.is_available = 1
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
				du.id=#{drugUserId}
				AND vdcim.virtual_drug_user_id=#{drugUserId}
		AND DATE_FORMAT(next_visit_time, '%Y-%m') = #{date}
		GROUP BY
			DATE_FORMAT(next_visit_time, '%Y-%m-%d')
		ORDER BY
			DATE_FORMAT(next_visit_time, '%Y-%m-%d')
	</select>

	<!-- 拜访医院总数 -->
	<select id="getVisitHospitalCount" resultType="java.lang.Integer">

		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		AND v.product_id = #{productId}
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION

		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.message_type = 1
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_share a ON d.id = a.share_person_id
		AND a.share_type = 2
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		) t

	</select>


	<!-- 拜访医生总数 -->
	<select id="getVisitDoctorCount" resultType="java.lang.Integer">

		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		AND v.product_id = #{productId}
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION

		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.message_type = 1
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_share a ON d.id = a.share_person_id
		AND a.share_type = 2
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		) t

	</select>


	<!-- 得到接触/覆盖/成功医院数量 -->
	<select id="getVisitTypeHospitalCount" resultType="java.lang.Integer">
		  SELECT
				COUNT(*)
			FROM
				(
					SELECT DISTINCT
						h.id
					FROM
						doctor d
					INNER JOIN hospital h ON d.hospital_id = h.id
					INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
					INNER JOIN drug_user du ON dud.drug_user_id = du.id
					INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
					INNER JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
					INNER JOIN virtual_doctor_call_info_result r ON m.id = r.mend_id
					INNER JOIN virtual_product_visit_result pr ON r.result_id = pr.id
					WHERE
						dud.is_available = 1
					AND dud.prod_id = #{productId}
					AND du.id IN
					<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
						#{drugUserId}
					</foreach>

					AND v.virtual_drug_user_id IN
					<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
						#{drugUserId}
					</foreach>

					<if test="startTime!=null and startTime !=''">
						AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
					</if>

					<if test="endTime!=null and endTime !=''">
						AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
					</if>

					AND v.product_id = #{productId}
					AND pr.visit_type LIKE CONCAT('%', #{visitType}, '%')
					UNION
						SELECT DISTINCT
							h.id
						FROM
							doctor d
						INNER JOIN hospital h ON d.hospital_id = h.id
						INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
						INNER JOIN drug_user du ON dud.drug_user_id = du.id
						INNER JOIN virtual_message vm ON d.id = vm.doctor_id
						AND vm.user_type = 2
						WHERE
							dud.is_available = 1
						AND du.id IN
						<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
							#{drugUserId}
						</foreach>
						AND dud.prod_id = #{productId}
						AND vm.drug_user_id IN
						<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
							#{drugUserId}
						</foreach>

						<if test="startTime!=null and startTime !=''">
							AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
						</if>

						<if test="endTime!=null and endTime !=''">
							AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
						</if>

						UNION
							SELECT DISTINCT
								h.id
							FROM
								doctor d
							INNER JOIN hospital h ON d.hospital_id = h.id
							INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
							INNER JOIN drug_user du ON dud.drug_user_id = du.id
							INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
							INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
							WHERE
								dud.is_available = 1
							AND dud.prod_id = #{productId}
							AND du.id IN
							<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
								#{drugUserId}
							</foreach>
							AND (
								tmd.product_id = #{productId}
								OR tmad.item_id IN (
									SELECT
										id
									FROM
										drug_product
									WHERE
										product_id = #{productId}
								)
							)


							<if test="startTime!=null and startTime !=''">
								AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
							</if>

							<if test="endTime!=null and endTime !=''">
								AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
							</if>


							UNION
								SELECT DISTINCT
									h.id
								FROM
									doctor d
								INNER JOIN hospital h ON d.hospital_id = h.id
								INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
								INNER JOIN drug_user du ON dud.drug_user_id = du.id
								INNER JOIN activity_read ar ON d.id = ar.read_person_id
								LEFT JOIN activity_read_ip ari ON ar.read_token = ari.read_token
								WHERE
									dud.is_available = 1
								AND dud.prod_id = #{productId}
								AND du.id IN
								<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
									#{drugUserId}
								</foreach>
								AND (
									ari.isp IS NULL
									OR ari.isp != '阿里云'
								)
								AND ar.drug_user_id IN

								<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
									#{drugUserId}
								</foreach>
								AND ar.data_id IN (
									SELECT DISTINCT
										content_id
									FROM
										t_content_product
									WHERE
										product_id = #{productId}
								)

							<if test="startTime!=null and startTime !=''">
								AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
							</if>

							<if test="endTime!=null and endTime !=''">
								AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
							</if>

								UNION
									SELECT DISTINCT
										h.id
									FROM
										doctor d
									INNER JOIN hospital h ON d.hospital_id = h.id
									INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
									INNER JOIN drug_user du ON dud.drug_user_id = du.id
									INNER JOIN wx_users wu ON d.id = wu.doctor_id
									INNER JOIN wx_user_read wur ON wu.id = wur.user_id
									WHERE
										dud.is_available = 1
									AND dud.prod_id = #{productId}
									AND du.id IN
									<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
										#{drugUserId}
									</foreach>
									AND wur.content_id IN (
										SELECT DISTINCT
											content_id
										FROM
											t_content_product
										WHERE
											product_id = #{productId}
									)

									<if test="startTime!=null and startTime !=''">
										AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
									</if>

									<if test="endTime!=null and endTime !=''">
										AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
									</if>

				) t
	</select>


	<!-- 得到接触/覆盖/成功过医生数量 -->
	<select id="getVisitTypeDoctorCount" resultType="java.lang.Integer">
		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		INNER JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
		INNER JOIN virtual_doctor_call_info_result r ON m.id = r.mend_id
		INNER JOIN virtual_product_visit_result pr ON r.result_id = pr.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		AND v.product_id = #{productId}
		AND pr.visit_type LIKE CONCAT('%', #{visitType}, '%')
		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.user_type = 2
		WHERE
		dud.is_available = 1
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND dud.prod_id = #{productId}
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_read ar ON d.id = ar.read_person_id
		LEFT JOIN activity_read_ip ari ON ar.read_token = ari.read_token
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		ari.isp IS NULL
		OR ari.isp != '阿里云'
		)
		AND ar.drug_user_id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND ar.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		) t
	</select>



	<!-- 电话外呼量 -->
	<select id="getCallCount" resultType="java.lang.Integer">
		SELECT
			COUNT(DISTINCT v.id)
		FROM
			doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
			dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>



	</select>


	<!-- 电话接通量 -->
	<select id="getConnectCallCount" resultType="java.lang.Integer">
		SELECT
		COUNT(DISTINCT v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1
		AND (v.status_name='answer' OR (call_url IS NOT NULL AND call_url!=''))

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

	</select>



	<!-- 通话时长 -->
	<select id="getCallTime" resultType="java.lang.Integer">
		SELECT
		SUM(v.call_time)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1
		AND (v.status_name='answer' OR (call_url IS NOT NULL AND call_url!=''))

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

	</select>


	<!-- 面谈次数 -->
	<select id="interviewVisit" resultType="java.lang.Integer">
		SELECT
		COUNT(v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=5

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>
	</select>


	<!-- 其他次数 -->
	<select id="otherVisit" resultType="java.lang.Integer">
		SELECT
		COUNT(v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel IN (2,3,4)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>
	</select>

</mapper>
