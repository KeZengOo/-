<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.VirtualDoctorCallInfoMapper">

	<select id="getCallVisitCount" resultType="java.lang.Integer">
		SELECT 
			count(*)
		FROM virtual_doctor_call_info v
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
	    WHERE v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )
	</select>
	
	<select id="getCallVisitList" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.CallVisitBean">
		SELECT 
			v.id AS callId, call_time AS callTime, status_name AS statueName, call_url AS callUrl, v.type,
			date_format(v.create_time, '%Y-%m-%d %H:%i:%S') AS createTime,
			remark,du.name AS drugUserName 
		FROM virtual_doctor_call_info v
		<!-- START  -->
		JOIN drug_user du
		ON v.virtual_drug_user_id = du.id
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
		<!-- END -->
	    WHERE v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )
		
		ORDER BY createTime DESC
		LIMIT #{currentSize}, #{pageSize}
	</select>

	<insert id="saveVirtualDoctorCallInfo" keyProperty="callId" useGeneratedKeys="true"
		parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		INSERT INTO virtual_doctor_call_info
		(sin_token, 
		 virtual_drug_user_id, virtual_doctor_id, doctor_questionnaire_id, product_id,
		 mobile, type, remark, status, status_name, create_time)
		VALUES
		(#{sinToken}, 
		 #{virtualDrugUserId}, #{virtualDoctorId}, #{doctorQuestionnaireId}, #{productId},
		 #{mobile}, #{type}, #{remark}, #{status}, #{statusName}, NOW())
	</insert>
	
	<update id="updateVirtualDoctorCallInfo" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		UPDATE virtual_doctor_call_info 
		SET product_id =  #{productId} ,doctor_questionnaire_id=#{doctorQuestionnaireId}
		WHERE id=#{callId}
	</update>
	
</mapper>
