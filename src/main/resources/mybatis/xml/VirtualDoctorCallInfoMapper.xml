<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.VirtualDoctorCallInfoMapper">

	<select id="getCallVisitCount" resultType="java.lang.Integer">
		SELECT 
			count(*)
		FROM virtual_doctor_call_info v
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
	    WHERE  v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )


		<if test="timeType != null and timeType == 1">
			AND v.create_time >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
		</if>

		<if test="timeType != null and timeType == 2">
			AND v.create_time >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
		</if>

		<if test="drugUserIdList !=null and drugUserIdList.size >0">
			AND v.virtual_drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>


	</select>
	
	<select id="getCallVisitList" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.CallVisitBean">
		SELECT 
			v.id AS callId, call_time AS callTime,v.visit_channel visitChannel, v.status_name AS statusName, call_url AS callUrl, v.type,
			date_format(v.create_time, '%Y-%m-%d %H:%i:%S') AS createTime,
			remark,du.name AS drugUserName 
		FROM virtual_doctor_call_info v
		<!-- START  -->
		JOIN drug_user du
		ON v.virtual_drug_user_id = du.id
		JOIN (
			SELECT 
				DISTINCT d.id  
			FROM drug_user_doctor dud
			JOIN doctor d
			ON d.id=dud.doctor_id
			JOIN  drug_user du
			ON dud.drug_user_id=du.id
			AND dud.doctor_id = #{virtualDoctorId}
			AND du.leader_path LIKE CONCAT(#{leaderPath},'%')
			AND dud.is_available=1
		) temp 
		ON v.virtual_doctor_id=temp.id
		<!-- END -->
	    WHERE  v.product_id IN (
	    	SELECT DISTINCT prod_id 
	    	FROM product_user pu
	    	JOIN drug_user du
	    	ON pu.user_id=du.id
	    	WHERE du.leader_path LIKE CONCAT(#{leaderPath},'%')
	    )

		<if test="timeType != null and timeType == 1">
			AND v.create_time >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
		</if>

		<if test="timeType != null and timeType == 2">
			AND v.create_time >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
		</if>

		<if test="drugUserIdList !=null and drugUserIdList.size >0">
			AND v.virtual_drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

		ORDER BY createTime DESC
		LIMIT #{currentSize}, #{pageSize}
	</select>

	<insert id="saveVirtualDoctorCallInfo" keyProperty="callId" useGeneratedKeys="true"
		parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		INSERT INTO virtual_doctor_call_info
		(sin_token, virtual_doctor_id, mobile, type, status, status_name, create_time, call_url, unpressed_call_url, unpressed_call_url_in, unpressed_call_url_out, call_time)
		VALUES
		(#{sinToken}, #{virtualDoctorId}, #{mobile}, #{type}, #{status}, #{statusName}, #{visitTime}, #{callUrl}, #{unpressedCallUrl}, #{unpressedCallUrlIn}, #{unpressedCallUrlOut},  #{callTime})
	</insert>
	
	<update id="updateVirtualDoctorCallInfo" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualDoctorCallInfoParams">
		UPDATE virtual_doctor_call_info 
		<set>
			<if test="productId != null and productId>0">
				product_id = #{productId} ,
			</if>
			<if test="doctorQuestionnaireId != null and doctorQuestionnaireId > 0">
				doctor_questionnaire_id=#{doctorQuestionnaireId},
			</if>
			<if test="callUrl != null and callUrl !=''">
				call_url=#{callUrl},
			</if>

			<if test="statusName !=null and statusName !=''">
				status_name=#{statusName},
			</if>

			<if test="status != null">
				status=#{status},
			</if>
			<if test="remark != null and remark !=''">
				remark=#{remark}
			</if>
		</set>
		WHERE id=#{callId}
	</update>

	<select id="geTelephoneDoctorVisitCount" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.StatisticsDrugNumResponse">
		<!-- 2018-09-29 修改前
		SELECT
		virtual_drug_user_id drugUserId,count(DISTINCT virtual_doctor_id) total
		FROM virtual_doctor_call_info
		WHERE
		virtual_drug_user_id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		<if test="startTime!=null">
			and date_format(create_time,'%Y-%m-%d')&gt;=#{startTime}
		</if>
		<if test="endTime!=null">
			and date_format(create_time,'%Y-%m-%d')&lt;=#{endTime}
		</if>
		AND product_id=#{productId}
		GROUP BY virtual_drug_user_id
		-->

		<!-- 2018-09-29 重构后 -->
		SELECT
		call_dud.drugUserId,
		COUNT(
		DISTINCT vdci.virtual_doctor_id
		) total
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		WHERE
		vdci.product_id
		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>
		GROUP BY
		call_dud.drugUserId

	</select>


	<!-- 医生拜访数：医生ID列表 -->
	<select id="geTelephoneDoctorVisitDoctorIdList" resultType="java.lang.Long">

		SELECT
		DISTINCT vdci.virtual_doctor_id
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		WHERE
		vdci.product_id
		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>

		<if test="self != null and self==1">
			AND vdci.virtual_drug_user_id IN
			<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>


	</select>


	<!-- 医生拜访数(拜访结果为（类型=接触医生）)：医生ID列表 -->
	<select id="getDoctorVisitContactDoctorIdList" resultType="java.lang.Long">

		SELECT
		DISTINCT vdci.virtual_doctor_id
		FROM
		virtual_doctor_call_info vdci
		INNER JOIN (
		SELECT DISTINCT
		d.id doctorId,
		du.id drugUserId
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
		INNER JOIN virtual_doctor_call_info_mend m
		ON vdci.id=m.call_id
		INNER JOIN virtual_doctor_call_info_result r
		ON m.id=r.mend_id
		INNER JOIN virtual_product_visit_result re
		ON r.result_id=re.id
		WHERE
		vdci.product_id=#{productId}
		<if test="visitResultType!=null and visitResultType!=0">
			AND re.visit_type LIKE CONCAT('%',#{visitResultType}, '%')
		</if>

		<if test="startTime!=null and startTime!=''">
			AND DATE_FORMAT(vdci.create_time,'%Y-%m-%d') &gt;=#{startTime}
		</if>
		<if test="endTime!=null and endTime!=''">
			AND DATE_FORMAT(vdci.create_time,'%Y-%m-%d') &lt;=#{endTime}
		</if>

		<if test="self!=null and self==1">
			AND vdci.virtual_drug_user_id IN
			<foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

	</select>


	<!-- 更新打电话的医生ID -->
	<update id="updateCallInfoDoctorId">
		UPDATE virtual_doctor_call_info SET virtual_doctor_id=#{doctorId}
		WHERE mobile IN
		<foreach collection="telephoneList" item="telephone" open="(" close=")" separator=",">
			#{telephone}
		</foreach>
		AND virtual_doctor_id IS NULL
	</update>


	<!-- 保存电话记录 -->
	<insert id="saveCallInfo" keyProperty="id" useGeneratedKeys="true" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.CallRequestBean">
		INSERT INTO virtual_doctor_call_info(sin_token,visit_channel, virtual_doctor_id, mobile, virtual_drug_user_id, status, status_name, call_time, call_url, type, product_id, create_time)
		VALUES
		(#{sinToken},#{visitChannel}, #{doctorId}, #{mobile}, #{drugUserId}, #{status}, #{statusName}, #{times}, #{url}, #{type}, #{productId}, #{createTime})
	</insert>


	<!-- 得到医生电话以及接通次数 -->
	<select id="getTelephoneCallCount" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CallTelephoneReponseBean">
		SELECT * FROM (
		SELECT t.telephone,
		(SELECT COUNT(*) FROM virtual_doctor_call_info WHERE mobile=t.telephone AND status_name = 'answer') callCount
		 FROM (

		SELECT
							telephone
						FROM
							doctor
						WHERE
							id = #{doctorId}
						AND LEFT (telephone, 1) = 1
						UNION
							SELECT
								telephone
							FROM
								doctor_telephone
							WHERE
								doctor_id = #{doctorId}

		) t
		) a ORDER BY a.callCount DESC


	</select>


	<!-- 得到医生电话以及接通次数 -->
	<select id="getAllTelephoneCallCount" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CallTelephoneReponseBean">
		SELECT * FROM (
		SELECT t.telephone,t.doctorId,
		(SELECT COUNT(*) FROM virtual_doctor_call_info WHERE mobile=t.telephone AND status_name = 'answer') callCount
		 FROM (

		SELECT
							telephone, id doctorId
						FROM
							doctor
						WHERE
							id IN
						<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
							#{doctorId}
						</foreach>


						AND LEFT (telephone, 1) = 1
						UNION
							SELECT
								telephone, doctor_id doctorId
							FROM
								doctor_telephone
							WHERE
								doctor_id IN
							<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
								#{doctorId}
							</foreach>


		) t
		) a


	</select>




	<update id="updateCallProduct">
		UPDATE virtual_doctor_call_info SET product_id=#{productId}
		WHERE id = #{callId}
	</update>


	<!-- 更新录音文本 -->
	<insert id="updateCallUrlText">
		REPLACE INTO virtual_doctor_call_text(sin_token, call_text) VALUES(#{sinToken}, #{callText})
	</insert>


	<!-- 更新录音文本重构版本 -->
	<insert id="updateCallUrlTextRefactor">
		REPLACE INTO virtual_doctor_call_text(sin_token, call_text, unpressed_call_text, unpressed_call_in_text, unpressed_call_out_text) VALUES(#{sinToken}, #{callText}, #{unpressedCallText}, #{unpressedCallInText}, #{unpressedCallOutText})
	</insert>


	<!-- 临时功能 -->
	<select id="getVisitHistoryList" resultType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean">
		SELECT
			doctor_id doctorId,
			old_drug_user_id drugUserId,
			mobile,
			visit_channel visitChannel,
			visit_time visitTime,
			remark,
			150 productId,
			UUID() sinToken,
			visit_result visitResult,
			attitude,
			have_drug haveDrug,
			recruit,
			have_ae haveAe,
			is_target target


		FROM
			a_ahistory_sfl
		WHERE
			doctor_id IS NOT NULL
		AND doctor_id != 0
	</select>

	<insert id="insertVisitHistory" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean"
			keyProperty="callId" useGeneratedKeys="true">
		INSERT INTO virtual_doctor_call_info(sin_token, virtual_doctor_id,virtual_drug_user_id, mobile, visit_channel, create_time, remark, product_id)
		VALUES (#{sinToken}, #{doctorId}, #{drugUserId}, #{mobile}, #{visitChannel}, #{visitTime}, #{remark}, #{productId})
	</insert>


	<insert id="insertVisitHistoryMend" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean"
			keyProperty="mendId" useGeneratedKeys="true">
		INSERT INTO virtual_doctor_call_info_mend(virtual_drug_user_id, virtual_doctor_id, product_id, call_id, attitude, hcp_potential, is_break_off, is_has_ae, is_target, is_has_drug, is_recruit, recruit_time)
		VALUES (#{drugUserId}, #{doctorId}, #{productId}, #{callId}, #{attitude}, -1, 0, #{haveAe}, #{target}, #{haveDrug}, #{recruit}, #{visitTime})
	</insert>

	<insert id="insertVisitHistoryMendResult" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.call.VisitHistoryRequestBean">
		INSERT INTO virtual_doctor_call_info_result(mend_id, result_id)
		VALUES(#{mendId},#{visitResult})
	</insert>

	<!-- 查询指定日期的计划拜访人数 -->
	<select id="getVisitCountList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.VisitCountResponseBean">
		SELECT
			COUNT(
				DISTINCT vdcim.virtual_doctor_id
			) as count,
			DATE_FORMAT(next_visit_time, '%Y-%m-%d') date
		FROM
			virtual_doctor_call_info_mend vdcim
		INNER JOIN doctor d ON vdcim.virtual_doctor_id = d.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		AND dud.is_available = 1
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
				du.id=#{drugUserId}
				AND vdcim.virtual_drug_user_id=#{drugUserId}
		AND DATE_FORMAT(next_visit_time, '%Y-%m') = #{date}
		GROUP BY
			DATE_FORMAT(next_visit_time, '%Y-%m-%d')
		ORDER BY
			DATE_FORMAT(next_visit_time, '%Y-%m-%d')
	</select>

	<!-- 拜访医院总数 -->
	<select id="getVisitHospitalCount" resultType="java.lang.Integer">

		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		AND v.product_id = #{productId}
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION

		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.message_type = 1
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_share a ON d.id = a.share_person_id
		AND a.share_type = 2
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		h.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		) t

	</select>


	<!-- 拜访医生总数 -->
	<select id="getVisitDoctorCount" resultType="java.lang.Integer">

		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		AND v.product_id = #{productId}
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION

		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.message_type = 1
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_share a ON d.id = a.share_person_id
		AND a.share_type = 2
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND a.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(a.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		) t

	</select>


	<!-- 得到接触/覆盖/成功医院数量 -->
	<select id="getVisitTypeHospitalCount" resultType="java.lang.Integer">
		  SELECT
				COUNT(*)
			FROM
				(
					SELECT DISTINCT
						h.id
					FROM
						doctor d
					INNER JOIN hospital h ON d.hospital_id = h.id
					INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
					INNER JOIN drug_user du ON dud.drug_user_id = du.id
					INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
					INNER JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
					INNER JOIN virtual_doctor_call_info_result r ON m.id = r.mend_id
					INNER JOIN virtual_product_visit_result pr ON r.result_id = pr.id
					WHERE
						dud.is_available = 1
					AND dud.prod_id = #{productId}
					AND du.id IN
					<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
						#{drugUserId}
					</foreach>

					AND v.virtual_drug_user_id IN
					<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
						#{drugUserId}
					</foreach>

					<if test="startTime!=null and startTime !=''">
						AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
					</if>

					<if test="endTime!=null and endTime !=''">
						AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
					</if>

					AND v.product_id = #{productId}
					AND pr.visit_type LIKE CONCAT('%', #{visitType}, '%')
					UNION
						SELECT DISTINCT
							h.id
						FROM
							doctor d
						INNER JOIN hospital h ON d.hospital_id = h.id
						INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
						INNER JOIN drug_user du ON dud.drug_user_id = du.id
						INNER JOIN virtual_message vm ON d.id = vm.doctor_id
						AND vm.user_type = 2
						WHERE
							dud.is_available = 1
						AND du.id IN
						<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
							#{drugUserId}
						</foreach>
						AND dud.prod_id = #{productId}
						AND vm.drug_user_id IN
						<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
							#{drugUserId}
						</foreach>

						<if test="startTime!=null and startTime !=''">
							AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
						</if>

						<if test="endTime!=null and endTime !=''">
							AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
						</if>

						UNION
							SELECT DISTINCT
								h.id
							FROM
								doctor d
							INNER JOIN hospital h ON d.hospital_id = h.id
							INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
							INNER JOIN drug_user du ON dud.drug_user_id = du.id
							INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
							INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
							WHERE
								dud.is_available = 1
							AND dud.prod_id = #{productId}
							AND du.id IN
							<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
								#{drugUserId}
							</foreach>
							AND (
								tmd.product_id = #{productId}
								OR tmad.item_id IN (
									SELECT
										id
									FROM
										drug_product
									WHERE
										product_id = #{productId}
								)
							)


							<if test="startTime!=null and startTime !=''">
								AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
							</if>

							<if test="endTime!=null and endTime !=''">
								AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
							</if>


							UNION
								SELECT DISTINCT
									h.id
								FROM
									doctor d
								INNER JOIN hospital h ON d.hospital_id = h.id
								INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
								INNER JOIN drug_user du ON dud.drug_user_id = du.id
								INNER JOIN activity_read ar ON d.id = ar.read_person_id
								LEFT JOIN activity_read_ip ari ON ar.read_token = ari.read_token
								WHERE
									dud.is_available = 1
								AND dud.prod_id = #{productId}
								AND du.id IN
								<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
									#{drugUserId}
								</foreach>
								AND (
									ari.isp IS NULL
									OR ari.isp != '阿里云'
								)
								<!-- 覆盖医生添加大于等于50秒限制 -->
								<if test="visitType !=null and visitType == 3">
									AND ar.read_time >=50
								</if>


								AND ar.drug_user_id IN

								<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
									#{drugUserId}
								</foreach>
								AND ar.data_id IN (
									SELECT DISTINCT
										content_id
									FROM
										t_content_product
									WHERE
										product_id = #{productId}
								)

							<if test="startTime!=null and startTime !=''">
								AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
							</if>

							<if test="endTime!=null and endTime !=''">
								AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
							</if>

								UNION
									SELECT DISTINCT
										h.id
									FROM
										doctor d
									INNER JOIN hospital h ON d.hospital_id = h.id
									INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
									INNER JOIN drug_user du ON dud.drug_user_id = du.id
									INNER JOIN wx_users wu ON d.id = wu.doctor_id
									INNER JOIN wx_user_read wur ON wu.id = wur.user_id
									WHERE
										dud.is_available = 1
									AND dud.prod_id = #{productId}
									AND du.id IN
									<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
										#{drugUserId}
									</foreach>
									AND wur.content_id IN (
										SELECT DISTINCT
											content_id
										FROM
											t_content_product
										WHERE
											product_id = #{productId}
									)

									<!-- 覆盖医生添加大于等于50秒限制 -->
									<if test="visitType !=null and visitType == 3">
										AND wur.read_time >=50
									</if>

									<if test="startTime!=null and startTime !=''">
										AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
									</if>

									<if test="endTime!=null and endTime !=''">
										AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
									</if>

				) t
	</select>


	<!-- 得到接触/覆盖/成功过医生数量 -->
	<select id="getVisitTypeDoctorCount" resultType="java.lang.Integer">
		SELECT
		COUNT(*)
		FROM
		(
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v ON d.id = v.virtual_doctor_id
		INNER JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
		INNER JOIN virtual_doctor_call_info_result r ON m.id = r.mend_id
		INNER JOIN virtual_product_visit_result pr ON r.result_id = pr.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		AND v.product_id = #{productId}
		AND pr.visit_type LIKE CONCAT('%', #{visitType}, '%')
		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_message vm ON d.id = vm.doctor_id
		AND vm.user_type = 2
		WHERE
		dud.is_available = 1
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND dud.prod_id = #{productId}
		AND vm.drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(vm.message_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN t_meeting_attend_details tmad ON d.id = tmad.doctor_id
		INNER JOIN t_meeting_data tmd ON tmad.meeting_id = tmd.id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		tmd.product_id = #{productId}
		OR tmad.item_id IN (
		SELECT
		id
		FROM
		drug_product
		WHERE
		product_id = #{productId}
		)
		)


		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(tmad.attend_start_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>


		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN activity_read ar ON d.id = ar.read_person_id
		LEFT JOIN activity_read_ip ari ON ar.read_token = ari.read_token
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND (
		ari.isp IS NULL
		OR ari.isp != '阿里云'
		)

		<!-- 覆盖医生添加大于等于50秒限制 -->
		<if test="visitType !=null and visitType == 3">
			AND ar.read_time >=50
		</if>

		AND ar.drug_user_id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND ar.data_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(ar.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		UNION
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN hospital h ON d.hospital_id = h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN wx_users wu ON d.id = wu.doctor_id
		INNER JOIN wx_user_read wur ON wu.id = wur.user_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND wur.content_id IN (
		SELECT DISTINCT
		content_id
		FROM
		t_content_product
		WHERE
		product_id = #{productId}
		)

		<!-- 覆盖医生添加大于等于50秒限制 -->
		<if test="visitType !=null and visitType == 3">
			AND wur.read_time >=50
		</if>

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(wur.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		) t
	</select>



	<!-- 电话外呼量 -->
	<select id="getCallCount" resultType="java.lang.Integer">
		SELECT
			COUNT(DISTINCT v.id)
		FROM
			doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
			dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>



	</select>


	<!-- 电话接通量 -->
	<select id="getConnectCallCount" resultType="java.lang.Integer">
		SELECT
		COUNT(DISTINCT v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1
		AND (v.status_name='answer' OR (call_url IS NOT NULL AND call_url!=''))

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

	</select>



	<!-- 通话时长 -->
	<select id="getCallTime" resultType="java.lang.String">

		<!-- 修改前 -->
		<!--
		SELECT
		ROUND(IFNULL(SUM(v.call_time), 0)/60,1) callTime
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=1
		AND (v.status_name='answer' OR (call_url IS NOT NULL AND call_url!=''))

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		-->



		SELECT
		ROUND(IFNULL(SUM(v.call_time), 0)/60,1) callTime
		FROM
		virtual_doctor_call_info v
		WHERE
		v.product_id = #{productId}
		AND v.virtual_drug_user_id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND v.visit_channel = 1
		AND (
		v.status_name = 'answer'
		OR (
		call_url IS NOT NULL
		AND call_url != ''
		)
		)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>

		AND v.virtual_doctor_id IN (
		SELECT
		id
		FROM
		(
		SELECT DISTINCT
		d.id
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		WHERE
		dud.prod_id = #{productId}
		AND dud.drug_user_id IN

		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		AND dud.is_available = 1
		) t
		)

	</select>


	<!-- 面谈次数 -->
	<select id="interviewVisit" resultType="java.lang.Integer">
		SELECT
		COUNT(DISTINCT v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel=5

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>
	</select>


	<!-- 其他次数 -->
	<select id="otherVisit" resultType="java.lang.Integer">
		SELECT
		COUNT(DISTINCT v.id)
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN virtual_doctor_call_info v
		ON d.id=v.virtual_doctor_id
		WHERE
		dud.is_available = 1
		AND dud.prod_id = #{productId}
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.product_id=#{productId}
		AND v.virtual_drug_user_id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		AND v.visit_channel IN (2,3,4)

		<if test="startTime!=null and startTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
		</if>

		<if test="endTime!=null and endTime !=''">
			AND DATE_FORMAT(v.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
		</if>
	</select>

	<!-- 分割录音文件并上传阿里云 -->
	<insert id="saveSplitSpeechAliyunPath" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualSplitSpeechAliyunPathParams">
		INSERT INTO virtual_split_speech_aliyun_path (
			targe_url,
			source_url,
			type,
			create_time
		)
		VALUES
		(
			#{targeUrl},
			#{sourceUrl},
			#{type},
			NOW()
		)
	</insert>

	<!-- 根据左右声道的阿里云地址进行语音识别，进行入库 -->
	<insert id="saveSpeechRecognitionResultCallInfo" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualSplitSpeechCallInfoParams">
		INSERT INTO virtual_split_speech_call_info (
			sin_token,
			type,
			begin_time,
			virtual_drug_user_id,
			text,
			create_time
		)
		VALUES
		<foreach collection="list" item="item" separator=",">
			(
			#{item.sinToken},
			#{item.type},
			#{item.beginTime},
			#{item.virtualDrugUserId},
			#{item.text},
			NOW()
			)
		</foreach>

	</insert>

    <!-- 根据sin_token获取virtual_doctor_call_info表中的id-->
    <select id="getCallInfoBySinToken" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualSplitSpeechCallInfoParams">
      SELECT t.id,t.sin_token sinToken,t.virtual_drug_user_id virtualDrugUserId

      FROM virtual_doctor_call_info t WHERE t.sin_token = #{sinToken}
    </select>

    <!-- 根据id获取virtual_doctor_call_info表中的sin_token-->
    <select id="getCallInfoById" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.VirtualSplitSpeechCallInfoParams">
      SELECT t.id,t.sin_token sinToken,t.virtual_drug_user_id virtualDrugUserId FROM virtual_doctor_call_info t WHERE t.id = #{id}
    </select>

	<select id="getCountByCallRequest" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM
			virtual_doctor_call_info
		WHERE
			visit_channel = 2
			AND virtual_doctor_id = #{doctorId}
			AND virtual_drug_user_id = #{drugUserId}
			AND product_id = #{productId}
			AND DATE_FORMAT( #{messageTime}, '%Y-%m-%d' ) = DATE_FORMAT( create_time, '%Y-%m-%d' )
	</select>


	<!-- 新增拜访的目的 -->
	<insert id="addCallPurpose">
		INSERT INTO virtual_doctor_call_purpose(call_id, item, result_id)
		VALUES
		<foreach collection="list" item="p">


			<foreach collection="p.resultIdList" item="resultId" separator=",">
				(
				#{p.callId},
				#{p.item},
				#{resultId}
				)
			</foreach>


		</foreach>

	</insert>


	<!-- 电话拜访记录查询 -->
	<select id="getDrugUserDoctorCallList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.DrugUserDoctorCallResponse">
		SELECT
			pl.prod_id productId,
			pl.prod_name productName,
			du.id drugUserId,
			du.NAME drugUserName,
		    GROUP_CONCAT(DISTINCT ro.role_name) drugUserRole,
			(
			CASE

				WHEN du.sale_type IS NULL THEN
				'未知'
				WHEN du.sale_type = 0 THEN
				'经理'
				WHEN du.sale_type = 1 THEN
				'线上'
				WHEN du.sale_type = 2 THEN
				'线下' ELSE '未知'
			END
			) AS drugUserVisitType,
			d.id doctorId,
			d.NAME doctorName,
			d.hospital_id hospitalId,
			d.hospital_name hospitalName,
			d.depart,
			(
			CASE

					WHEN q.is_cover IS NULL THEN
					'未知'
					WHEN q.is_cover = 0 THEN
					'未开始'
					WHEN q.is_cover = 1 THEN
					'覆盖中'
					WHEN q.is_cover = 2 THEN
					'退出项目' ELSE '未知'
				END
				) AS coverStatus,
				(
				CASE

						WHEN q.is_recruit IS NULL THEN
						'未知'
						WHEN q.is_recruit = 0 THEN
						'未招募'
						WHEN q.is_recruit = 1 THEN
						'已招募' ELSE '未知'
					END
					) AS recruitStatus,
					IFNULL(COUNT(DISTINCT v.id), 0) callCount,

					(
					SELECT
					IFNULL(SUM(call_time), 0)
					FROM
					virtual_doctor_call_info
					WHERE
					virtual_drug_user_id = v.virtual_drug_user_id
					AND virtual_doctor_id = v.virtual_doctor_id
					AND product_id = v.product_id
					AND visit_channel = 1
					AND status_name = 'answer'
					<if test="startTime !=null and endTime !=null">
						AND v.create_time BETWEEN #{startTime} AND  #{endTime}
					</if>

					) totalCallSecond,

					(
					SELECT
						COUNT( * )
					FROM
						virtual_doctor_call_info
					WHERE
						virtual_drug_user_id = v.virtual_drug_user_id
						AND virtual_doctor_id = v.virtual_doctor_id
						AND product_id = v.product_id
						AND visit_channel = 1
						AND status_name = 'answer'
						<if test="startTime !=null and endTime !=null">
						AND v.create_time BETWEEN #{startTime} AND  #{endTime}
						</if>

					) connectCallCount,
					MAX( v.create_time ) lastVisitDate,
					(
					SELECT
						IFNULL(call_time, 0)
					FROM
						virtual_doctor_call_info
					WHERE
						virtual_drug_user_id = v.virtual_drug_user_id
						AND virtual_doctor_id = v.virtual_doctor_id
						AND product_id = v.product_id
						AND visit_channel = 1
						<if test="startTime !=null and endTime !=null">
						AND v.create_time BETWEEN #{startTime} AND  #{endTime}
						</if>

					ORDER BY
						v.create_time DESC
						LIMIT 1
					) lastCallSecond
				FROM
					virtual_doctor_call_info v
					INNER JOIN drug_user du ON v.virtual_drug_user_id = du.id
					LEFT JOIN role_user ru
					ON du.id=ru.user_id AND ru.role_id > 100
					LEFT JOIN role ro
					ON ru.role_id=ro.id
					INNER JOIN doctor d ON v.virtual_doctor_id = d.id
					INNER JOIN product_doctor_quate q ON v.product_id = q.product_id
					AND v.virtual_doctor_id = q.doctor_id
					INNER JOIN product_line pl ON v.product_id = pl.prod_id
				WHERE
					v.visit_channel = 1
					<if test="startTime !=null and endTime !=null">
						AND v.create_time BETWEEN #{startTime} AND  #{endTime}
					</if>


					<if test="drugUserIdList !=null and drugUserIdList.size > 0">
						AND v.virtual_drug_user_id IN
						<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
							#{drugUserId}
						</foreach>
					</if>

					<if test="productIdList !=null and productIdList.size > 0">
						AND v.product_id IN
						<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
							#{productId}
						</foreach>
					</if>


					<if test="recruit !=null">
						AND q.is_recruit=#{recruit}
					</if>

					<if test="cover !=null">
						AND q.is_cover=#{cover}
					</if>

					<if test="target !=null">
						AND q.is_target =#{target}
					</if>

					<if test="hasDrug!=null">
						AND q.is_has_drug=#{hasDrug}
					</if>

					<if test="searchKeyword !=null and searchKeyword !=''">
						AND d.id IN
						(
						SELECT
						id
						FROM
						doctor
						WHERE
						telephone LIKE CONCAT('%', #{searchKeyword}, '%')
						OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
						OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
						OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
						UNION
						SELECT
						doctor_id
						FROM
						doctor_telephone
						WHERE
						telephone LIKE CONCAT('%', #{searchKeyword}, '%')
						)
					</if>


				GROUP BY
					v.virtual_drug_user_id,
					v.virtual_doctor_id,
					v.product_id
					<if test="paginable == null or paginable == 0">
						LIMIT #{currentSize}, #{pageSize}
					</if>
	</select>



	<!-- 电话拜访记录查询 -->
	<select id="getDrugUserDoctorCallListCount" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM (
		SELECT
		v.virtual_drug_user_id,
		v.virtual_doctor_id,
		v.product_id
		FROM
		virtual_doctor_call_info v
		INNER JOIN drug_user du ON v.virtual_drug_user_id = du.id
		INNER JOIN doctor d ON v.virtual_doctor_id = d.id
		INNER JOIN product_doctor_quate q ON v.product_id = q.product_id
		AND v.virtual_doctor_id = q.doctor_id
		INNER JOIN product_line pl ON v.product_id = pl.prod_id
		WHERE
		v.visit_channel = 1
		<if test="startTime !=null and endTime !=null">
			AND v.create_time BETWEEN #{startTime} AND #{ endTime}
		</if>


		<if test="drugUserIdList !=null and drugUserIdList.size > 0">
			AND v.virtual_drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

		<if test="productIdList !=null and productIdList.size > 0">
			AND v.product_id IN
			<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
				#{productId}
			</foreach>
		</if>


		<if test="recruit !=null">
			AND q.is_recruit=#{recruit}
		</if>

			<if test="cover !=null">
				AND q.is_cover=#{cover}
			</if>

			<if test="target !=null">
				AND q.is_target =#{target}
			</if>

			<if test="hasDrug!=null">
				AND q.is_has_drug=#{hasDrug}
			</if>



			<if test="searchKeyword !=null and searchKeyword !=''">
				AND d.id IN
				(
				SELECT
				id
				FROM
				doctor
				WHERE
				telephone LIKE CONCAT('%', #{searchKeyword}, '%')
				OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
				OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
				OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
				UNION
				SELECT
				doctor_id
				FROM
				doctor_telephone
				WHERE
				telephone LIKE CONCAT('%', #{searchKeyword}, '%')
				)
			</if>


		GROUP BY
			v.virtual_drug_user_id,
			v.virtual_doctor_id,
			v.product_id
		) t

	</select>


	<!-- 拜访详情列表 -->
	<select id="getDrugUserDoctorCallDetailList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.DrugUserDoctorCallDetailResponse">
		SELECT
			v.id,
			DATE_FORMAT( v.create_time, '%Y-%m-%d %H:%i:%s' ) create_time,
			IFNULL( v.call_time, 0 ) callSecond,
			IFNULL( GROUP_CONCAT( DISTINCT p.item ), '' ) purpose,
			IFNULL( GROUP_CONCAT( DISTINCT r.visit_result ), '' ) visitResult,
			IFNULL( v.call_url, '' ) callUrl,
			IFNULL( t.call_text, '' ) callText,
			v.visit_channel visitChannel
		FROM
			virtual_doctor_call_info v
			LEFT JOIN virtual_doctor_call_text t ON v.sin_token = t.sin_token
			LEFT JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
			LEFT JOIN virtual_doctor_call_info_result re ON m.id = re.mend_id
			LEFT JOIN virtual_product_visit_result r ON re.result_id = r.id
			LEFT JOIN virtual_doctor_call_purpose p ON v.id = p.call_id
		WHERE
			v.virtual_doctor_id = #{doctorId}
			AND v.virtual_drug_user_id = #{drugUserId}
			AND v.product_id = #{productId}
			<if test="visitChannel !=null and visitChannel !=0">
				AND v.visit_channel=#{visitChannel}
			</if>

		GROUP BY
			v.id
		ORDER BY
			v.create_time DESC
			LIMIT #{currentSize}, #{pageSize}
	</select>


	<!-- 拜访详情列表总数 -->
	<select id="getDrugUserDoctorCallDetailListCount" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM (
			SELECT
				v.id
			FROM
				virtual_doctor_call_info v
				LEFT JOIN virtual_doctor_call_text t ON v.sin_token = t.sin_token
				LEFT JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
				LEFT JOIN virtual_doctor_call_info_result re ON m.id = re.mend_id
				LEFT JOIN virtual_product_visit_result r ON re.result_id = r.id
				LEFT JOIN virtual_doctor_call_purpose p ON v.id = p.call_id
			WHERE
				v.virtual_doctor_id = #{doctorId}
				AND v.virtual_drug_user_id = #{drugUserId}
				AND v.product_id = #{productId}
				<if test="visitChannel !=null and visitChannel !=0">
					AND v.visit_channel=#{visitChannel}
				</if>
			GROUP BY
				v.id
		) t
	</select>

</mapper>
