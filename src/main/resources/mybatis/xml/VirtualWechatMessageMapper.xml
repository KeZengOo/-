<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.VirtualWechatMessageMapper">


    <!-- 微信概况列表 -->
    <select id="getWechatMessageSummaryList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.WechatMessageSummaryResponse">
            SELECT * FROM (
            SELECT du.id drugUserId,
            du.name drugUserName,
            pl.prod_id productId,
            pl.prod_name productName,
            GROUP_CONCAT(DISTINCT r.role_name) roleName,
            (
            CASE WHEN du.sale_type IS NULL
            THEN '未知'
            WHEN du.sale_type=0
            THEN '经理'
            WHEN du.sale_type=1
            THEN '线上'
            WHEN du.sale_type=2
            THEN '线下'
            ELSE '未知'
            END
            ) AS saleType,
            d.id doctorId,
            '' chatRoomId,
            d.name doctorName,
            d.hospital_id hospitalId,
            d.hospital_name hospitalName,
            d.depart,
            (
            CASE WHEN q.is_recruit IS NULL
            THEN '未知'
            WHEN q.is_recruit=0
            THEN '否'
            WHEN q.is_recruit=1
            THEN '是'
            ELSE '未知'
            END
            ) recruitStatus,

            (
            CASE WHEN q.is_cover IS NULL
            THEN '未知'
            WHEN q.is_cover=0
            THEN '未开始'
            WHEN q.is_cover=1
            THEN '覆盖中'
            WHEN q.is_cover=2
            THEN '退出项目'
            ELSE '未知'
            END
            ) coverStatus,

            (
            SELECT COUNT(*) FROM virtual_message WHERE doctor_id=d.id
            ) totalDialogCount,

            (
            SELECT COUNT(*) FROM virtual_message WHERE doctor_id=d.id AND user_type=1
            ) drugUserDialogCount,
            (
            SELECT COUNT(*) FROM virtual_message WHERE doctor_id=d.id AND user_type=2
            ) doctorDialogCount,
            IF(MAX(vm.upload_time) IS NULL OR MAX(vm.upload_time) = 0, '', FROM_UNIXTIME(IFNULL(MAX(vm.upload_time),0)/1000, '%Y-%m-%d %H:%i:%s')) lastSyncTime,
            1 messageType
            FROM drug_user du
            LEFT JOIN role_user ru
            ON du.id=ru.user_id AND ru.role_id>100
            LEFT JOIN role r
            ON ru.role_id=r.id
            INNER JOIN drug_user_doctor dud
            ON du.id=dud.drug_user_id
            INNER JOIN doctor d
            ON dud.doctor_id=d.id
            INNER JOIN virtual_message vm
            ON d.id=vm.doctor_id
            INNER JOIN product_line pl
            ON dud.prod_id=pl.prod_id
            LEFT JOIN product_doctor_quate q
            ON dud.doctor_id=q.doctor_id AND dud.prod_id=q.product_id
            WHERE dud.is_available=1

            <if test="drugUserIdList !=null and drugUserIdList.size > 0">
                AND dud.drug_user_id IN
                <foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
                    #{drugUserId}
                </foreach>
            </if>

            <if test="productIdList !=null and productIdList.size > 0">
                AND dud.prod_id IN
                <foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
                    #{productId}
                </foreach>
            </if>

            <if test="searchKeyword !=null and searchKeyword !=''">
                AND d.id IN
                (
                SELECT
                id
                FROM
                doctor
                WHERE
                telephone LIKE CONCAT('%', #{searchKeyword}, '%')
                OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
                OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
                UNION
                SELECT
                doctor_id
                FROM
                doctor_telephone
                WHERE
                telephone LIKE CONCAT('%', #{searchKeyword}, '%')
                )
            </if>

            GROUP BY dud.drug_user_id, dud.doctor_id, dud.prod_id

            UNION ALL

            SELECT du.id drugUserId,
            du.name drugUserName,
            pl.prod_id productId,
            pl.prod_name productName,
            GROUP_CONCAT(DISTINCT r.role_name) roleName,
            (
            CASE WHEN du.sale_type IS NULL
            THEN '未知'
            WHEN du.sale_type=0
            THEN '经理'
            WHEN du.sale_type=1
            THEN '线上'
            WHEN du.sale_type=2
            THEN '线下'
            ELSE '未知'
            END
            ) AS saleType,
            '' doctorId,
            c.chatroom_id chatRoomId,
            cc.chatroom_name doctorName,
            '' hospitalId,
            '' hospitalName,
            '' depart,
            '' is_recruit,
            '' is_cover,
            COUNT(DISTINCT c.id) totalDialogCount,
            '' drugUserDialogCount,
            '' doctorDialogCount,
            (
            SELECT IF(MAX(upload_time) IS NULL OR MAX(upload_time) = 0, '', FROM_UNIXTIME(IFNULL(MAX(upload_time),0)/1000, '%Y-%m-%d %H:%i:%s'))
            FROM virtual_message WHERE wechat_number=c.chatroom_id
            ) lastSyncTime,
            2 messageType
            FROM virtual_message_chatroom c
            INNER JOIN virtual_wechat_chatroom_contact cc
            ON c.chatroom_id=cc.chatroom_id
            INNER JOIN drug_user du
            ON c.drug_user_id=du.id
            INNER JOIN product_user pu
            ON du.id=pu.user_id
            INNER JOIN product_line pl
            ON pu.prod_id=pl.prod_id
            LEFT JOIN role_user ru
            ON du.id=ru.user_id
            LEFT JOIN role r
            ON ru.role_id=r.id
            WHERE 1=1
            <if test="drugUserIdList !=null and drugUserIdList.size > 0">
                AND du.id IN
                <foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
                    #{drugUserId}
                </foreach>
            </if>

            <if test="productIdList !=null and productIdList.size > 0">
                AND pl.prod_id IN
                <foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
                    #{productId}
                </foreach>
            </if>


            GROUP BY pu.user_id, pu.prod_id,c.chatroom_id
            ) t
        WHERE 1=1
        <if test="messageType!=null and messageType !=0">
            AND t.messageType=#{messageType}
        </if>

        <if test="paginable == null or paginable == 0">
            LIMIT #{currentSize}, #{pageSize}
        </if>


    </select>


    <!-- 微信概况列表总数 -->
    <select id="getWechatMessageSummaryListCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM (
        SELECT
        1 messageType
        FROM drug_user du
        LEFT JOIN role_user ru
        ON du.id=ru.user_id AND ru.role_id>100
        LEFT JOIN role r
        ON ru.role_id=r.id
        INNER JOIN drug_user_doctor dud
        ON du.id=dud.drug_user_id
        INNER JOIN doctor d
        ON dud.doctor_id=d.id
        INNER JOIN virtual_message vm
        ON d.id=vm.doctor_id
        INNER JOIN product_line pl
        ON dud.prod_id=pl.prod_id
        LEFT JOIN product_doctor_quate q
        ON dud.doctor_id=q.doctor_id AND dud.prod_id=q.product_id
        WHERE dud.is_available=1

        <if test="drugUserIdList !=null and drugUserIdList.size > 0">
            AND dud.drug_user_id IN
            <foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
                #{drugUserId}
            </foreach>
        </if>

        <if test="productIdList !=null and productIdList.size > 0">
            AND dud.prod_id IN
            <foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
                #{productId}
            </foreach>
        </if>

        <if test="searchKeyword !=null and searchKeyword !=''">
            AND d.id IN
            (
            SELECT
            id
            FROM
            doctor
            WHERE
            telephone LIKE CONCAT('%', #{searchKeyword}, '%')
            OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
            OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
            OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
            UNION
            SELECT
            doctor_id
            FROM
            doctor_telephone
            WHERE
            telephone LIKE CONCAT('%', #{searchKeyword}, '%')
            )
        </if>

        GROUP BY dud.drug_user_id, dud.doctor_id, dud.prod_id

        UNION ALL
        SELECT
        2 messageType
        FROM virtual_message_chatroom c INNER JOIN drug_user du
        ON c.drug_user_id=du.id
        INNER JOIN product_user pu
        ON du.id=pu.user_id
        INNER JOIN product_line pl
        ON pu.prod_id=pl.prod_id
        LEFT JOIN role_user ru
        ON du.id=ru.user_id
        LEFT JOIN role r
        ON ru.role_id=r.id

        WHERE 1=1

        <if test="drugUserIdList !=null and drugUserIdList.size > 0">
            AND du.id IN
            <foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
                #{drugUserId}
            </foreach>
        </if>

        <if test="productIdList !=null and productIdList.size > 0">
            AND pl.prod_id IN
            <foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
                #{productId}
            </foreach>
        </if>


        GROUP BY pu.user_id, pu.prod_id,c.chatroom_id
        ) t
        WHERE 1=1
        <if test="messageType!=null and messageType !=0">
            AND t.messageType=#{messageType}
        </if>

    </select>


</mapper>