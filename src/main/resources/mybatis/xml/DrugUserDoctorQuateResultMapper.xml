<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.DrugUserDoctorQuateResultMapper">


    <insert id="batchInsert">
        INSERT INTO drug_user_doctor_quate_result (quate_id, result_id)
        VALUES
        <foreach collection ="resultIdList" item="resultId" separator =",">
            (#{quateId}, #{resultId})
        </foreach>
    </insert>

    <insert id="batchInsertProductDoctor">
        INSERT INTO product_doctor_quate_result (quate_id, result_id)
        VALUES
        <foreach collection ="resultIdList" item="resultId" separator =",">
            (#{quateId}, #{resultId})
        </foreach>
    </insert>


    <select id="getVisitResult" resultType="java.lang.String">
        SELECT
            DISTINCT b.visit_result
        FROM
            drug_user_doctor_quate_result a
        INNER JOIN virtual_product_visit_result b ON a.result_id = b.id
        WHERE
            a.quate_id = (
                SELECT
                    id
                FROM
                    drug_user_doctor_quate
                WHERE
                doctor_id = #{doctorId}
                <if test="productList !=null and productList.size > 0">
                    AND product_id IN
                    <foreach collection="productList" item="productId" open="(" close=")" separator=",">
                        #{productId}
                    </foreach>
                </if>


                ORDER BY
                    create_time DESC
                LIMIT 1
            )
    </select>




    <select id="getVisitResultList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.VisitResultResponseBean">
        SELECT DISTINCT
            b.visit_result visitResult,
            quate.doctorId
        FROM
            drug_user_doctor_quate_result a
        INNER JOIN virtual_product_visit_result b ON a.result_id = b.id
        INNER JOIN (
            SELECT
                MAX(id) quateId,
                doctor_id doctorId
            FROM
                drug_user_doctor_quate q
            WHERE 1=1

            <if test="doctorIdList !=null and doctorIdList.size > 0">
                AND q.doctor_id IN
                <foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
                    #{doctorId}
                </foreach>
            </if>


            <if test="productList !=null and productList.size > 0">
                AND q.product_id IN
                <foreach collection="productList" item="productId" open="(" close=")" separator=",">
                    #{productId}
                </foreach>
            </if>

            GROUP BY
                doctor_id
        ) quate ON a.quate_id = quate.quateId
        WHERE b.visit_result IS NOT NULL AND b.visit_result !=''
    </select>

    <!-- 得到不同拜访结果的医生 -->
    <select id="getVisitResultDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.statistics.VisitResultDoctorResponseBean">

        SELECT
        vpvr.visit_result visitResult,
        IFNULL(t.doctorCount, 0) doctorCount
        FROM
        virtual_product_visit_result vpvr
        LEFT JOIN (
        SELECT
        COUNT(DISTINCT d.id) doctorCount,
        pr.id
        FROM
        doctor d
        INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
        INNER JOIN drug_user du ON dud.drug_user_id = du.id
        INNER JOIN drug_user_doctor_quate q ON dud.doctor_id = q.doctor_id
        AND dud.drug_user_id = q.drug_user_id
        AND dud.prod_id = q.product_id
        INNER JOIN drug_user_doctor_quate_result qr ON qr.quate_id = q.id
        INNER JOIN virtual_product_visit_result pr ON qr.result_id = pr.id
        WHERE
        dud.is_available = 1
        AND dud.prod_id = #{productId}
        AND du.id IN

        <foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
            #{drugUserId}
        </foreach>

        <if test="startTime!=null and startTime !=''">
            AND DATE_FORMAT(qr.create_time, '%Y-%m-%d') >=DATE_FORMAT(#{startTime}, '%Y-%m-%d')
        </if>

        <if test="endTime!=null and endTime !=''">
            AND DATE_FORMAT(qr.create_time, '%Y-%m-%d') &lt;=DATE_FORMAT(#{endTime}, '%Y-%m-%d')
        </if>

        GROUP BY
        pr.id
        ) t ON vpvr.id = t.id
        WHERE
        vpvr.product_id = #{productId}
        ORDER BY
        vpvr.id


    </select>

</mapper>