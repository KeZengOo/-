<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.CoverageReportMapper">

	<!-- 根据产品id查询招募医生和医院数据 -->
	<select id="getRecruitCount" resultType="com.nuoxin.virtual.rep.api.entity.v3_0.CoverageReportPart">
		SELECT count(distinct d.id) hcpId,count(distinct h.id) hciId
		FROM virtual_doctor_call_info v
		INNER JOIN doctor d ON v.virtual_doctor_id = d.id
		INNER JOIN virtual_doctor_call_info_mend m ON v.id=m.call_id
		INNER JOIN hospital h on h.id = d.hospital_id
		WHERE v.product_id = #{productId} AND m.is_recruit = 1
	</select>

	<!-- 根据产品id和时间段查询招募医生和医院数据 -->
    <select id="findRecruitList" resultType="com.nuoxin.virtual.rep.api.entity.v3_0.CoverageReportPart">
		SELECT
		d.id hcpId,h.id hciId,DATE_FORMAT(m.create_time,'%Y-%m') timeStr
		FROM
		virtual_doctor_call_info v
		INNER JOIN doctor d ON v.virtual_doctor_id = d.id
		INNER JOIN virtual_doctor_call_info_mend m ON v.id=m.call_id
		INNER JOIN hospital h on h.id = d.hospital_id
		WHERE v.product_id = #{productId} AND m.is_recruit= 1
		AND DATE_FORMAT(m.create_time, '%Y-%m') &lt;= #{endTime}
		GROUP BY d.id, m.create_time
    </select>

	<!-- 根据产品id和时间段查询覆盖医生和医院数据 -->
	<select id="findCoverageList" resultType="com.nuoxin.virtual.rep.api.entity.v3_0.CoverageReportPart">
		-- 电话覆盖 拜访登记覆盖
		SELECT DISTINCT d.id hcpId, h.id hciId, DATE_FORMAT(b.create_time,'%Y-%m') timeStr FROM `virtual_doctor_call_info` a
		INNER JOIN doctor d ON a.virtual_doctor_id = d.id
		INNER JOIN virtual_doctor_call_info_mend b on a.id = b.call_id
		INNER JOIN hospital h on h.id = d.hospital_id
		WHERE b.is_recruit = 1 AND a.product_id = #{productId} AND (a.status_name = 'answer' or a.visit_channel != 1)
		AND DATE_FORMAT(a.create_time,'%Y-%m') &gt;= #{startTime} AND DATE_FORMAT(a.create_time,'%Y-%m') &lt;= #{endTime}
		UNION
		-- 文章阅读
		SELECT DISTINCT d.id hcpId, h.id hciId, DATE_FORMAT(r.create_time,'%Y-%m') timeStr FROM
		t_content_product a
		INNER JOIN activity_read r ON r.data_id = a.content_id
		INNER JOIN doctor d ON r.read_person_id = d.id
		INNER JOIN hospital h on h.id = d.hospital_id
		LEFT JOIN activity_read_ip i ON i.read_token = r.read_token
		WHERE a.product_id = #{productId}
		AND DATE_FORMAT(r.create_time,'%Y-%m') &gt;= #{startTime} AND DATE_FORMAT(r.create_time,'%Y-%m') &lt;= #{endTime}
		AND (i.isp != '阿里云' OR i.isp IS NULL) AND d.id IN (
		<include refid="recruitHcp"/>
		AND pd.product_id = #{productId}
		)
		UNION
		-- 微信回复
		SELECT DISTINCT d.id doctorId, h.id userId, DATE_FORMAT(b.message_time,'%Y-%m') total FROM drug_user_doctor a
		JOIN `virtual_message` b ON a.doctor_id = b.doctor_id AND a.drug_user_id = b.drug_user_id
		JOIN doctor d ON b.doctor_id = d.id
		JOIN hospital h on h.id = d.hospital_id
		WHERE a.is_available = 1 AND a.prod_id = #{productId} AND b.user_type = 2
		and DATE_FORMAT(b.message_time,'%Y-%m') &gt;= #{startTime} AND DATE_FORMAT(b.message_time,'%Y-%m') &lt;= #{endTime}
		AND b.wechat_message_type NOT IN ('系统消息','撤回提醒') AND d.id IN (
		<include refid="recruitHcp"/>
		AND pd.product_id = #{productId}
		)
		UNION
		-- 会议覆盖
		SELECT DISTINCT d.id doctorId, h.id userId, DATE_FORMAT(b.attend_start_time,'%Y-%m') total FROM
		t_meeting_data a
		INNER JOIN t_meeting_attend_details b ON a.id = b.meeting_id
		INNER JOIN drug_user_doctor c ON b.doctor_id = c.doctor_id and a.product_id = c.prod_id
		INNER JOIN virtual_doctor_call_info_mend pd on c.prod_id = pd.product_id and c.doctor_id = pd.virtual_doctor_id
		INNER JOIN doctor d ON b.doctor_id = d.id
		INNER JOIN hospital h on h.id = d.hospital_id
		WHERE pd.is_recruit = 1 AND c.prod_id = #{productId} AND c.is_available = 1
		AND DATE_FORMAT(b.attend_start_time,'%Y-%m') &gt;= #{startTime} AND DATE_FORMAT(b.attend_start_time,'%Y-%m') &lt;= #{endTime}
	</select>

	<sql id="recruitHcp">
		SELECT DISTINCT
		pd.virtual_doctor_id
		FROM
		virtual_doctor_call_info_mend pd
		WHERE pd.is_recruit = 1 AND pd.virtual_doctor_id > 0
	</sql>

	<!-- 根据产品id和时间段查询招募医生 -->
	<select id="findCoverageRecruitList" resultType="com.nuoxin.virtual.rep.api.entity.v3_0.CoverageReportPart">
		SELECT
		d.id hcpId,DATE_FORMAT(m.create_time,'%Y-%m') timeStr
		FROM
		virtual_doctor_call_info v
		INNER JOIN doctor d ON v.virtual_doctor_id = d.id
		INNER JOIN virtual_doctor_call_info_mend m ON v.id=m.call_id
		WHERE v.product_id = #{productId} AND m.is_recruit= 1
		AND DATE_FORMAT(m.create_time, '%Y-%m') &lt;= #{endTime}
		GROUP BY d.id, m.create_time
	</select>

	<!-- 电话覆盖 -->
	<select id="findCoverageCallList" resultType="com.nuoxin.virtual.rep.api.entity.v3_0.CoverageReportPart">
		-- 电话覆盖
		SELECT d.id hcpId, a.call_time hciId, DATE_FORMAT(b.create_time,'%Y-%m') timeStr FROM `virtual_doctor_call_info` a
		INNER JOIN doctor d ON a.virtual_doctor_id = d.id
		INNER JOIN virtual_doctor_call_info_mend b on a.id = b.call_id
		WHERE b.is_recruit = 1 AND a.product_id = #{productId} AND a.status_name = 'answer' AND a.visit_channel = 1
		AND DATE_FORMAT(a.create_time,'%Y-%m') &gt;= #{startTime} AND DATE_FORMAT(a.create_time,'%Y-%m') &lt;= #{endTime}
	</select>

</mapper>