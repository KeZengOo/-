<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.DrugUserDoctorQuateMapper">
	<insert id="backupRelationShipInfo">
		INSERT INTO drug_user_doctor_quate_log 
		(drug_user_id,doctor_id,product_id, is_has_drug,is_target,
		is_has_ae,is_recruit, is_break_off, hcp_potential)
		
		SELECT drug_user_id,doctor_id,product_id, is_has_drug,is_target,
		is_has_ae, is_recruit, is_break_off, hcp_potential
		FROM drug_user_doctor_quate
		WHERE  
			drug_user_id = #{virtualDrugUserId} 
			AND doctor_id =  #{doctorId} 
			AND product_id = #{productLineId}
	</insert>	
	
	<!-- 使用 MYSQL 私有语法, 通过 drug_user_id, doctor_id, product_id 创建唯一约束 -->
	<insert id="replaceRelationShipInfo">
		REPLACE INTO drug_user_doctor_quate 
		(drug_user_id,doctor_id,product_id, is_has_drug,is_target,
		is_has_ae, is_break_off, hcp_potential)
		VALUE (#{virtualDrugUserId}, #{doctorId}, #{productLineId}, #{isHasDrug}, #{isTarget}, 
		#{isHasAe}, #{isBreakOff}, #{hcpPotential})
	</insert>
	
	<insert id="saveDrugUserDoctorQuates" parameterType="com.nuoxin.virtual.rep.api.entity.v2_5.DrugUserDoctorQuateParams">
		INSERT INTO drug_user_doctor_quate 
		(drug_user_id,doctor_id,product_id, is_has_drug,
		 is_target,is_has_ae, is_recruit, hcp_potential)
		VALUES
		<foreach collection ="list" item="index" separator =",">
			 (#{index.virtualDrugUserId}, #{index.doctorId}, #{index.productLineId}, #{index.isHasDrug}, 
			 #{index.isTarget}, #{index.isHasAe}, #{index.isRecruit}, #{index.hcpPotential})
		</foreach>
	</insert>

	<select id="getPotentialDoctorCount" resultType="com.nuoxin.virtual.rep.api.entity.v2_5.StatisticsDrugNumResponse">
		SELECT
		drug_user_id drugUserId,count(DISTINCT doctor_id) total
		FROM drug_user_doctor_quate
		WHERE
		drug_user_id IN
		<foreach collection="statisticsParams.drugUserIds" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>
		<if test="statisticsParams.startTime!=null">
			and date_format(create_time,'%Y-%m-%d')&gt;=#{statisticsParams.startTime}
		</if>
		<if test="statisticsParams.endTime!=null">
			and date_format(create_time,'%Y-%m-%d')&lt;=#{statisticsParams.endTime}
		</if>
		AND product_id=#{statisticsParams.productId} and is_available=1 and hcp_potential=#{hcpPotential}
		GROUP BY drug_user_id
	</select>
		
</mapper>