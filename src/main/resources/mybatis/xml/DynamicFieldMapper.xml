<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.DynamicFieldMapper">

    <select id="getDoctorBasicInfo" parameterType="java.lang.Long"
            resultType="com.nuoxin.virtual.rep.api.web.controller.response.doctor.DoctorBasicInfoResponseBean">
        <!--
        select distinct vddf.type,vddf.id fieldId,vddf.field_name field,vddf.field_value fieldValue, vddfv.dynamic_field_value value,vddfv.id ddfvId, vddf.classification from
        virtual_doctor_dynamic_field vddf
        inner join virtual_doctor_dynamic_field_value vddfv
        on vddf.id=vddfv.dynamic_field_id
        where vddfv.doctor_id=#{doctorId}
        -->


        select * from (
        select distinct vddf.type,vddf.id fieldId,vddf.field_name field,vddf.field_value fieldValue, vddfv.dynamic_field_value value,vddfv.id ddfvId, vddf.classification from
        virtual_doctor_dynamic_field vddf
        inner join virtual_doctor_dynamic_field_value vddfv
        on vddf.id=vddfv.dynamic_field_id
        where vddfv.doctor_id=#{doctorId}
        union
        select 1 type,vddfv.dynamic_field_id fieldId, vddfv.dynamic_field_name filed, null fieldValue ,vddfv.dynamic_field_value value,vddfv.id ddfvId,0 classification
        from virtual_doctor_dynamic_field_value vddfv
        where vddfv.dynamic_field_id=0 and vddfv.doctor_id=#{doctorId}
        ) t order by t.classification


    </select>



    <delete id="deleteAllByDoctorIdAndClassification">

        delete from virtual_doctor_dynamic_field_value where doctor_id=#{doctorId}
        and dynamic_field_id in
        (select id from virtual_doctor_dynamic_field where classification=#{classification})

    </delete>


    <insert id="insertHcpBasicField" useGeneratedKeys="true" keyProperty="id" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.hcp.HcpBasicFieldRequestBean">
        insert into virtual_doctor_dynamic_field_value(doctor_id, dynamic_field_id, dynamic_field_name,dynamic_field_value)
        values (#{doctorId}, #{fieldId}, #{key}, #{value})
    </insert>

    <insert id="insertHcpBasicFieldHistory" useGeneratedKeys="true" keyProperty="id" parameterType="com.nuoxin.virtual.rep.api.web.controller.request.hcp.HcpBasicFieldRequestBean">
        insert into virtual_doctor_dynamic_field_value_history(ddfv_id,doctor_id,drug_user_id, dynamic_field_id, dynamic_field_name,dynamic_field_value, correct)
        values (#{ddfvId},#{doctorId},#{drugUserId}, #{fieldId}, #{key}, #{value}, #{correct})
    </insert>


</mapper>