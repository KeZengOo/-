<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.DoctorMapper">


    <select id="getCustomerSumStatistic"
            resultType="com.nuoxin.virtual.rep.api.web.controller.response.work.CustomerSumResponseBean"
            parameterType="com.nuoxin.virtual.rep.api.web.controller.request.WorkStationRequestBean">
        select count(vd.client_level) as typeSum ,vd.client_level as type from virtual_doctor vd
        inner join virtual_drug_user_doctor vdud
        on vd.id = vdud.virtual_doctor_id
        where vdud.product_id=#{productId}
        and vd.drug_user_ids like #{drugUserIdStr}
        group by vd.client_level

    </select>


    <select id="getCustomerAddStatistic"
            resultType="com.nuoxin.virtual.rep.api.web.controller.response.work.CustomerSumResponseBean"
            parameterType="com.nuoxin.virtual.rep.api.web.controller.request.WorkStationRequestBean">

    </select>


    <select id="getCustomerCoveredStatistic"
            resultType="com.nuoxin.virtual.rep.api.web.controller.response.work.CustomerSumResponseBean"
            parameterType="com.nuoxin.virtual.rep.api.web.controller.request.WorkStationRequestBean">

    </select>


    <update id="updateFixedField">

        update doctor set name=#{name}, mobile=#{telephone}, depart = #{depart}, hospital_name = #{hospital}

        where id = #{doctorId}


        update doctor
        <set>

            <if test="name !=null and name !=''">
                name = #{name},
            </if>

            <if test="mobile !=null and mobile !=''">
                name = #{mobile},
            </if>

            <if test="depart !=null and depart !=''">
                name = #{depart},
            </if>

            <if test="hospital_name !=null and hospital_name !=''">
                name = #{hospital}
            </if>


        </set>

        where id = #{doctor}



    </update>


    <update id="updateFixedName" parameterType="com.nuoxin.virtual.rep.api.web.controller.response.hcp.HcpDynamicRequestBean">
        update doctor set name = #{name} where id=#{doctorId}
    </update>

    <update id="updateFixedTelephone" parameterType="com.nuoxin.virtual.rep.api.web.controller.response.hcp.HcpDynamicRequestBean">
        update doctor set telephone = #{telephone} where id=#{doctorId}
    </update>

    <update id="updateFixedDepart" parameterType="com.nuoxin.virtual.rep.api.web.controller.response.hcp.HcpDynamicRequestBean">
        update doctor set depart = #{depart} where id=#{doctorId}
    </update>

    <update id="updateFixedHospital" parameterType="com.nuoxin.virtual.rep.api.web.controller.response.hcp.HcpDynamicRequestBean">
        update doctor set hospital_name = #{hospital} where id=#{doctorId}
    </update>

	<!-- 以下是虚拟工作台 v2.5 后用到的 -->
	<select id="getDoctorIdByMobile" resultType="java.lang.Long">
		SELECT doctor_id FROM (
		SELECT id doctor_id FROM doctor WHERE telephone=#{mobile}
		UNION
		SELECT doctor_id FROM doctor_telephone WHERE telephone=#{mobile}
		) t
		LIMIT 1
	</select>


	<!-- 根据手机号查找医生 -->
	<select id="findTopByMobile" resultType="com.nuoxin.virtual.rep.api.entity.Doctor">
		  SELECT
			DISTINCT
			d.id,
			d.email,
			d.`name`,
			d.hospital_id hospitalId,
			d.hospital_name hospitalName,
			d.provice province,
			d.city,
			d.depart department,
			d.sex
		FROM
			doctor d
		WHERE d.telephone=#{mobile}
		OR d.id=(SELECT doctor_id FROM doctor_telephone WHERE telephone=#{mobile} LIMIT 1)

	</select>

	<!-- 根据过滤条件获取医生总条数 -->
	<select id="getListCount" resultType="java.lang.Integer">
		<!-- 根据 virtualDrugUserIds 获取对应医生基本信息 -->
		SELECT COUNT(DISTINCT d.id)
		FROM doctor d
		LEFT JOIN hospital h ON d.hospital_id=h.id
		LEFT JOIN doctor_mend dm
		ON d.id=dm.virtual_doctor_id
		JOIN (

		<!-- 根据 virtualDrugUserIds 获取对应的 doctorIds -->
		SELECT
		doctor_id,min(DATE_FORMAT(modify_time,'%Y-%m-%d %H:%i:%s')) doctorCreateTime,
		IF(drug_user_id=#{drugUserId},1,0) click
		FROM drug_user_doctor
		WHERE is_available=1

		<!-- 管理员不用筛选代表 -->
		<if test="manager ==null or manager ==0">
			AND drug_user_id IN
			<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
				#{virtualDrugUserId}
			</foreach>
		</if>


		<!-- 根据产品线 ID 筛选 -->
		<if test="productLineIds != null">
			AND prod_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>
		</if>
		GROUP BY doctor_id
		) temp  ON  d.id=temp.doctor_id



		<!-- 左连接 virtual_doctor_call_info_mend 表获取电话拜访信息 -->
		LEFT JOIN (
		SELECT c.virtual_doctor_id, c.create_time,
		m.visit_result, m.next_visit_time FROM virtual_doctor_call_info c
		LEFT JOIN virtual_doctor_call_info_mend m
		ON m.call_id=c.id
		WHERE c.id IN (
		SELECT MAX(id) FROM virtual_doctor_call_info  WHERE virtual_drug_user_id IN
		<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
			#{virtualDrugUserId}
		</foreach>

		<if test="productLineIds != null">
			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>
		</if>

		GROUP BY virtual_doctor_id
		)

		) tel_visit ON tel_visit.virtual_doctor_id=d.id


		<!-- 下次拜访时间为今天的或者过期的，过期的置顶 -->
		<if test="searchType !=null and searchType==1">
			INNER JOIN (
			SELECT
			v.virtual_doctor_id,
			DATE_FORMAT(
			max(v.create_time),
			'%Y-%m-%d'
			) maxTime,
			DATE_FORMAT(
			max(m.next_visit_time),
			'%Y-%m-%d'
			) nextTime,
			DATEDIFF(NOW(),max(m.next_visit_time)) as overtime

			FROM
			virtual_doctor_call_info v
			LEFT JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
			WHERE
			v.virtual_drug_user_id IN

			<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
				#{virtualDrugUserId}
			</foreach>

			GROUP BY
			v.virtual_doctor_id
			HAVING
			nextTime &gt;= maxTime
			AND
			nextTime &lt;= DATE_FORMAT(NOW(), '%Y-%m-%d')
			) st1 ON temp.doctor_id=st1.virtual_doctor_id
		</if>

		<!-- 其他搜索 -->
		<if test="searchType==2 or searchType==3 or searchType==4 or (searchType==5 and meetingTimeType==1) or (searchType==6 and meetingTimeType==1)">

			INNER JOIN (

			<foreach collection="VisitDoctorList" item="v" index="index">
				<if test="index==0">
					SELECT #{v.doctorId} 'doctorId', #{v.visitIntervalDay} 'visitIntervalDay'
				</if>

				<if test="index !=0">
					UNION
					SELECT #{v.doctorId} 'doctorId', #{v.visitIntervalDay} 'visitIntervalDay'
				</if>
			</foreach>

			) st2 ON temp.doctor_id=st2.doctorId
		</if>


		<if test="searchType==5 and meetingTimeType==2">
			INNER JOIN (

			SELECT
			tmad.doctor_id doctorId,
			round(
			(
			UNIX_TIMESTAMP(m.start_time) - UNIX_TIMESTAMP(NOW())
			) / 60
			) AS overMinute
			FROM
			t_meeting_attend_details tmad
			INNER JOIN (
			SELECT
			id,
			tma.start_time
			FROM
			t_meeting_data tma
			WHERE
			DATE_FORMAT(tma.start_time, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
			AND tma.product_id
			) m ON tmad.meeting_id = m.id
			LEFT JOIN virtual_meeting_no_remind r ON m.id = r.meeting_id
			WHERE
			r.id IS NULL
			HAVING overMinute &gt;=0 AND
			overMinute &lt;= (
			SELECT
			min(
			<!-- 小时 -->
			before_meeting_frequency * 60
			)
			FROM
			virtual_product_visit_frequency
			WHERE
			product_id
			IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>
			)

			) st5 ON temp.doctor_id=st5.doctorId
		</if>


		<if test="searchType==6">
			<if test="meetingTimeType == 2">
				INNER JOIN (
				SELECT
				round(
				(
				UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(tmd.end_time)
				) / 60
				) AS overMinute,
				MAX(tmd.end_time) asMaxEndTime,
				tmad.doctor_id doctorId
				FROM
				t_meeting_data tmd
				INNER JOIN t_meeting_attend_details tmad ON tmd.id = tmad.meeting_id
				INNER JOIN drug_user_doctor dud ON tmad.doctor_id = dud.doctor_id
				AND is_available = 1
				WHERE
				dud.drug_user_id IN

				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				AND dud.prod_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
				GROUP BY
				tmad.doctor_id
				HAVING
				overMinute &lt;= (
				SELECT
				min(
				after_meeting_frequency * 60
				)
				FROM
				virtual_product_visit_frequency
				WHERE
				product_id
				IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
				)
				AND tmad.doctor_id NOT IN (
				SELECT DISTINCT
				virtual_doctor_id
				FROM
				virtual_doctor_call_info
				WHERE
				virtual_drug_user_id IN

				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>

				AND

				product_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>

				AND create_time >= MAX(tmd.end_time)
				)

				) st6 ON temp.doctor_id=st6.doctorId
			</if>

		</if>

		WHERE 1=1
		<!-- 搜索 -->
		<if test="search != null">
			AND (
			d.name LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.hospital_name LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.telephone LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.depart LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.id IN (
			SELECT doctor_id FROM doctor_telephone WHERE telephone LIKE "%"#{search,jdbcType=VARCHAR}"%"
			)
			)
		</if>


		<!-- 高级搜索 -->

		<!-- 医生基本信息搜索 -->
		<if test="sex!=null">
			AND d.sex=#{sex}
		</if>

		<if test="email!=null and email !=''">
			AND d.email LIKE CONCAT('%', #{email}, '%')
		</if>

		<if test="title!=null and title!=''">
			AND d.positions LIKE CONCAT('%', #{title}, '%')
		</if>

		<if test="depart !=null and depart !=''">
			AND d.depart LIKE CONCAT('%', #{depart}, '%')
		</if>

		<if test="wechat !=null and wechat !=''">
			AND dm.wechat LIKE CONCAT('%', #{wechat}, '%')
		</if>

		<if test="address !=null and address !=''">
			AND d.id IN (SELECT DISTINCT virtual_doctor_id FROM doctor_mend WHERE address LIKE CONCAT('%', #{address}, '%'))
		</if>

		<if test="isAddWechat !=null">
			<if test="isAddWechat == 1">
				<!--
				AND dm.wechat IS NOT NULL AND dm.wechat!=''
				-->

				AND d.id IN (
				SELECT
				doctor_id
				FROM
				drug_user_doctor_one_to_one
				WHERE
				is_add_wechat = 1
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				)
			</if>

			<if test="isAddWechat == 0">
				<!--
				AND (dm.wechat IS NULL OR dm.wechat='')
				-->

				AND d.id IN (
				SELECT
				doctor_id
				FROM
				drug_user_doctor_one_to_one
				WHERE
				(is_add_wechat IS NULL OR is_add_wechat=0)
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				)

			</if>
		</if>

		<if test="startDoctorCreateTime !=null and startDoctorCreateTime !=''">
			AND DATE_FORMAT(temp.doctorCreateTime, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startDoctorCreateTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endDoctorCreateTime !=null and endDoctorCreateTime !=''">
			AND DATE_FORMAT(temp.doctorCreateTime, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endDoctorCreateTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<!-- 医院高级搜索 -->
		<if test="hospitalId !=null and hospitalId !=0">
			AND h.id=#{hospitalId}
		</if>

		<if test="hospitalProvince !=null and hospitalProvince !=''">
			AND h.province=#{hospitalProvince}
		</if>

		<if test="hospitalCity !=null and hospitalCity !=''">
			AND h.city LIKE #{hospitalCity}
		</if>

		<if test="hospitalGrade !=null">
			AND h.level=#{hospitalGrade}
		</if>

		<!-- 处方信息固定字段高级搜索 -->
		<if test="hasDrug !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_has_drug=#{hasDrug}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>


			)
		</if>

		<if test="target !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_target=#{target}

			<if test="manager == null or manager == 0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<if test="recruit !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_recruit=#{recruit}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<if test="breakOff !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_break_off=#{breakOff}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<!-- 拜访记录高级搜索 -->
		<if test="startLastVisitTime !=null and startLastVisitTime !=''">
			AND DATE_FORMAT(tel_visit.create_time, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startLastVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endLastVisitTime !=null and endLastVisitTime !=''">
			AND DATE_FORMAT(tel_visit.create_time, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endLastVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="startNextVisitTime !=null and startNextVisitTime !=''">
			AND DATE_FORMAT(tel_visit.next_visit_time, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startNextVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endNextVisitTime !=null and endNextVisitTime !=''">
			AND DATE_FORMAT(tel_visit.next_visit_time, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endNextVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="interviewResult !=null and interviewResult.size >0">
			AND d.id IN (
			SELECT DISTINCT q.doctor_id FROM drug_user_doctor_quate q
			INNER JOIN drug_user_doctor_quate_result r
			ON q.id=r.quate_id
			WHERE

			q.product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			<if test="manager==null or manager==1">
				AND q.drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND r.result_id IN
			<foreach collection="interviewResult" item="resultId" open="(" close=")" separator=",">
				#{resultId}
			</foreach>
			)
		</if>


		<!-- 动态字段筛选 -->
		<if test="valueList !=null and valueList.size >0">


			<foreach collection="valueList" item="v" index="index">

				AND d.id IN (

				SELECT DISTINCT doctor_id FROM virtual_doctor_dynamic_field_value WHERE 1=1
				AND dynamic_field_id=#{v.dynamicFieldId}
				AND (
				<foreach collection="v.dynamicFieldValueList" item="v2" separator="OR">
					dynamic_field_value LIKE CONCAT('%', #{v2}, '%')
				</foreach>
				)
				)
			</foreach>

		</if>

	</select>

	<!-- 根据过滤条件获取医生拜访列表信息(不含对应的产品信息) -->
	<select id="getList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CustomerFollowListBean">
		<!-- 根据 virtualDrugUserIds 获取对应医生基本信息 -->
		SELECT
			d.id AS doctorId, d.name AS doctorName, d.telephone AS doctorMobile,
			d. sex AS gender, d.depart AS department,
		    d.hospital_id AS hospitalId, d.hospital_name AS hospitalName,
		    h.province, h.city,
		    d.email, d.positions AS title,IFNULL(h.level,0) hospitalLevel,
			tel_visit.create_time AS visitTime,tel_visit.next_visit_time AS nextVisitTime,
			IFNULL(TIMESTAMPDIFF(SECOND,NOW(), tel_visit.next_visit_time), #{minValue}) orderNextVisitTime,
			tel_visit.visit_result AS visitResult,
			dm.wechat, dm.secondary_mobile AS secondaryDoctorMobile, dm.thirdary_mobile AS thirdaryDoctorMobile,
		temp.doctorCreateTime,temp.click,temp.drugUserName
		FROM doctor d
		LEFT JOIN hospital h ON d.hospital_id=h.id
		LEFT JOIN doctor_mend dm
			ON d.id=dm.virtual_doctor_id
		JOIN (

			<!-- 根据 virtualDrugUserIds 获取对应的 doctorIds -->
			SELECT
				a.doctor_id,min(DATE_FORMAT(modify_time,'%Y-%m-%d %H:%i:%s')) doctorCreateTime,
				a.drug_user_name drugUserName,
				<!--
				IF(drug_user_id=#{drugUserId},1,0) click
				-->
				(SELECT IF(COUNT(*) >=1,1,0) FROM drug_user_doctor WHERE is_available=1 AND doctor_id=a.doctor_id AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				AND prod_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
				) as click
			FROM drug_user_doctor a
			WHERE is_available=1

				<!-- 管理员不用筛选代表 -->
				<if test="manager ==null or manager ==0">
					AND drug_user_id IN
					<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
						#{virtualDrugUserId}
					</foreach>
				</if>

		  	
		  	<!-- 根据产品线 ID 筛选 -->
		  	<if test="productLineIds != null">
	            AND prod_id IN 
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
                  #{productLineId}
  				</foreach> 
			</if>
		   GROUP BY doctor_id
	  	) temp  ON  d.id=temp.doctor_id
	  	

		
		<!-- 左连接 virtual_doctor_call_info_mend 表获取电话拜访信息 -->
		LEFT JOIN (
			SELECT c.virtual_doctor_id, c.create_time,
			m.visit_result, m.next_visit_time FROM virtual_doctor_call_info c 
			LEFT JOIN virtual_doctor_call_info_mend m		
				ON m.call_id=c.id	
			WHERE c.id IN (
				SELECT MAX(id) FROM virtual_doctor_call_info  WHERE virtual_drug_user_id IN 
 				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
		   			#{virtualDrugUserId}
		  		</foreach>

				<if test="productLineIds != null">
					AND product_id IN
					<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
						#{productLineId}
					</foreach>
				</if>

		  		GROUP BY virtual_doctor_id
			) 
			
		) tel_visit ON tel_visit.virtual_doctor_id=d.id


		<!-- 下次拜访时间为今天的或者过期的，过期的置顶 -->
		<if test="searchType !=null and searchType==1">
			INNER JOIN (
			SELECT
			v.virtual_doctor_id,
			DATE_FORMAT(
			max(v.create_time),
			'%Y-%m-%d'
			) maxTime,
			DATE_FORMAT(
			max(m.next_visit_time),
			'%Y-%m-%d'
			) nextTime,
			DATEDIFF(NOW(),max(m.next_visit_time)) as overtime

			FROM
			virtual_doctor_call_info v
			LEFT JOIN virtual_doctor_call_info_mend m ON v.id = m.call_id
			WHERE
			v.virtual_drug_user_id IN

			<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
				#{virtualDrugUserId}
			</foreach>

			<if test="productLineIds != null">
				AND v.product_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
			</if>

			GROUP BY
			v.virtual_doctor_id
			HAVING
			nextTime &gt;= maxTime
			AND
			nextTime &lt;= DATE_FORMAT(NOW(), '%Y-%m-%d')
			) st1 ON temp.doctor_id=st1.virtual_doctor_id
		</if>

		<!-- 其他搜索 -->
		<if test="searchType==2 or searchType==3 or searchType==4 or (searchType==5 and meetingTimeType==1) or (searchType==6 and meetingTimeType==1)">

			INNER JOIN (

			<foreach collection="VisitDoctorList" item="v" index="index">
				<if test="index==0">
					SELECT #{v.doctorId} 'doctorId', #{v.visitIntervalDay} 'visitIntervalDay'
				</if>

				<if test="index !=0">
					UNION
					SELECT #{v.doctorId} 'doctorId', #{v.visitIntervalDay} 'visitIntervalDay'
				</if>
			</foreach>

			) st2 ON temp.doctor_id=st2.doctorId
		</if>


		<if test="searchType==5 and meetingTimeType==2">
			INNER JOIN (

			SELECT
			tmad.doctor_id doctorId,
			round(
			(
			UNIX_TIMESTAMP(m.start_time) - UNIX_TIMESTAMP(NOW())
			) / 60
			) AS overMinute
			FROM
			t_meeting_attend_details tmad
			INNER JOIN (
			SELECT
			id,
			tma.start_time
			FROM
			t_meeting_data tma
			WHERE
			DATE_FORMAT(tma.start_time, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
			AND tma.product_id
			) m ON tmad.meeting_id = m.id
			LEFT JOIN virtual_meeting_no_remind r ON m.id = r.meeting_id
			WHERE
			r.id IS NULL
			HAVING overMinute &gt;=0 AND
			overMinute &lt;= (
			SELECT
			min(
			<!-- 小时 -->
			  before_meeting_frequency * 60
			)
			FROM
			virtual_product_visit_frequency
			WHERE
			product_id
			IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
			</foreach>
			)

			) st5 ON temp.doctor_id=st5.doctorId
		</if>


		<if test="searchType==6">
			<if test="meetingTimeType == 2">
				INNER JOIN (
				SELECT
				round(
				(
				UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(tmd.end_time)
				) / 60
				) AS overMinute,
				MAX(tmd.end_time) asMaxEndTime,
				tmad.doctor_id doctorId
				FROM
				t_meeting_data tmd
				INNER JOIN t_meeting_attend_details tmad ON tmd.id = tmad.meeting_id
				INNER JOIN drug_user_doctor dud ON tmad.doctor_id = dud.doctor_id
				AND is_available = 1
				WHERE
				dud.drug_user_id IN

				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				AND dud.prod_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
				GROUP BY
				tmad.doctor_id
				HAVING
				overMinute &lt;= (
				SELECT
				min(
				after_meeting_frequency * 60
				)
				FROM
				virtual_product_visit_frequency
				WHERE
				product_id
				IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>
				)
				AND tmad.doctor_id NOT IN (
				SELECT DISTINCT
				virtual_doctor_id
				FROM
				virtual_doctor_call_info
				WHERE
				virtual_drug_user_id IN

				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>

				AND

				product_id IN
				<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
					#{productLineId}
				</foreach>

				AND create_time >= MAX(tmd.end_time)
				)

				) st6 ON temp.doctor_id=st6.doctorId
			</if>

		</if>

		WHERE 1=1
		<!-- 搜索 -->
		<if test="search != null">
			AND (
			d.name LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.hospital_name LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.telephone LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.depart LIKE "%"#{search,jdbcType=VARCHAR}"%"
			OR d.id IN (
			SELECT doctor_id FROM doctor_telephone WHERE telephone LIKE "%"#{search,jdbcType=VARCHAR}"%"
			)
			)
		</if>


		<!-- 高级搜索 -->

		<!-- 医生基本信息搜索 -->
		<if test="sex!=null">
			AND d.sex=#{sex}
		</if>

		<if test="email!=null and email !=''">
			AND d.email LIKE CONCAT('%', #{email}, '%')
		</if>

		<if test="title!=null and title!=''">
			AND d.positions LIKE CONCAT('%', #{title}, '%')
		</if>

		<if test="depart !=null and depart !=''">
			AND d.depart LIKE CONCAT('%', #{depart}, '%')
		</if>

		<if test="wechat !=null and wechat !=''">
			AND dm.wechat LIKE CONCAT('%', #{wechat}, '%')
		</if>

		<if test="address !=null and address !=''">
			AND d.id IN (SELECT DISTINCT virtual_doctor_id FROM doctor_mend WHERE address LIKE CONCAT('%', #{address}, '%'))
		</if>

		<if test="isAddWechat !=null">
			<if test="isAddWechat == 1">
				<!--
				AND dm.wechat IS NOT NULL AND dm.wechat!=''
				-->

				AND d.id IN (
				SELECT
				doctor_id
				FROM
				drug_user_doctor_one_to_one
				WHERE
				is_add_wechat = 1
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				)
			</if>

			<if test="isAddWechat == 0">
				<!--
				AND (dm.wechat IS NULL OR dm.wechat='')
				-->

				AND d.id IN (
				SELECT
				doctor_id
				FROM
				drug_user_doctor_one_to_one
				WHERE
				(is_add_wechat IS NULL OR is_add_wechat=0)
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
				)

			</if>
		</if>

		<if test="startDoctorCreateTime !=null and startDoctorCreateTime !=''">
			AND DATE_FORMAT(temp.doctorCreateTime, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startDoctorCreateTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endDoctorCreateTime !=null and endDoctorCreateTime !=''">
			AND DATE_FORMAT(temp.doctorCreateTime, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endDoctorCreateTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<!-- 医院高级搜索 -->
		<if test="hospitalId !=null and hospitalId !=0">
			AND h.id=#{hospitalId}
		</if>

		<if test="hospitalProvince !=null and hospitalProvince !=''">
			AND h.province=#{hospitalProvince}
		</if>

		<if test="hospitalCity !=null and hospitalCity !=''">
			AND h.city LIKE #{hospitalCity}
		</if>

		<if test="hospitalGrade !=null">
			AND h.level=#{hospitalGrade}
		</if>

		<!-- 处方信息固定字段高级搜索 -->
		<if test="hasDrug !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_has_drug=#{hasDrug}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>


			)
		</if>

		<if test="target !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_target=#{target}

			<if test="manager == null or manager == 0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<if test="recruit !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_recruit=#{recruit}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<if test="breakOff !=null">
			AND d.id IN (SELECT DISTINCT doctor_id FROM drug_user_doctor_quate WHERE
			is_break_off=#{breakOff}

			<if test="manager==null or manager==0">
				AND drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			)
		</if>

		<!-- 拜访记录高级搜索 -->
		<if test="startLastVisitTime !=null and startLastVisitTime !=''">
			AND DATE_FORMAT(tel_visit.create_time, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startLastVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endLastVisitTime !=null and endLastVisitTime !=''">
			AND DATE_FORMAT(tel_visit.create_time, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endLastVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="startNextVisitTime !=null and startNextVisitTime !=''">
			AND DATE_FORMAT(tel_visit.next_visit_time, '%Y-%m-%d %H:%i:%s') &gt;= DATE_FORMAT(#{startNextVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="endNextVisitTime !=null and endNextVisitTime !=''">
			AND DATE_FORMAT(tel_visit.next_visit_time, '%Y-%m-%d %H:%i:%s') &lt;= DATE_FORMAT(#{endNextVisitTime}, '%Y-%m-%d %H:%i:%s')
		</if>

		<if test="interviewResult !=null and interviewResult.size >0">
			AND d.id IN (
			SELECT DISTINCT q.doctor_id FROM drug_user_doctor_quate q
			INNER JOIN drug_user_doctor_quate_result r
			ON q.id=r.quate_id
			WHERE

			q.product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>

			<if test="manager==null or manager==1">
				AND q.drug_user_id IN
				<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
					#{virtualDrugUserId}
				</foreach>
			</if>


			AND r.result_id IN
			<foreach collection="interviewResult" item="resultId" open="(" close=")" separator=",">
				#{resultId}
			</foreach>
			)
		</if>


		<!-- 动态字段筛选 -->
		<if test="valueList !=null and valueList.size >0">


			<foreach collection="valueList" item="v" index="index">

				AND d.id IN (

					SELECT DISTINCT doctor_id FROM virtual_doctor_dynamic_field_value WHERE 1=1
					AND dynamic_field_id=#{v.dynamicFieldId}
					AND (
					<foreach collection="v.dynamicFieldValueList" item="v2" separator="OR">
						dynamic_field_value LIKE CONCAT('%', #{v2}, '%')
					</foreach>
					)
				)
			</foreach>

		</if>




		GROUP BY d.id

		<!-- 排序规则 -->
		<if test="order ==null or order ==0">
			<if test="searchType ==null or searchType == 0">
				ORDER BY sign(orderNextVisitTime) DESC,abs(orderNextVisitTime)
			</if>

			<!--
			<if test="searchType != null and searchType ==1">
				ORDER BY st1.overtime DESC
			</if>
           -->

			<if test="searchType != null and searchType ==1">
				ORDER BY tel_visit.create_time
			</if>

			<if test="searchType==2 or searchType==3 or searchType==4">
				ORDER BY st2.visitIntervalDay DESC
			</if>
		</if>

		<if test="order !=null and order !=0">
			<if test="order == 1">
				ORDER BY sign(orderNextVisitTime) ASC,abs(orderNextVisitTime) DESC
			</if>

			<if test="order == 2">
				ORDER BY tel_visit.create_time DESC
			</if>

			<if test="order == 3">
				ORDER BY tel_visit.create_time ASC
			</if>

			<if test="order == 4">
				ORDER BY temp.doctorCreateTime DESC
			</if>

			<if test="order == 5">
				ORDER BY temp.doctorCreateTime ASC
			</if>
		</if>

		<if test="NonPagingFlag == null">
			LIMIT #{currentSize},#{pageSize}
		</if>
	</select>


	<!-- 得到今日分型要拜访的医生列表以及医生距离上次拜访天数 -->
	<select id="getClassificationVisitDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.plan.VisitDoctorResponseBean">
		SELECT
			DATE_FORMAT(
				max(v.create_time),
				'%Y-%m-%d'
			) AS maxVisitTime,
			DATEDIFF(NOW(), max(v.create_time)) AS days,
			virtual_doctor_id doctorId
		FROM
			virtual_doctor_call_info v
		WHERE
			v.virtual_drug_user_id IN

		<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
			#{virtualDrugUserId}
		</foreach>

		AND v.product_id
		IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>

		GROUP BY
			v.virtual_doctor_id

		ORDER BY
			days DESC
	</select>

	<!-- 得到医生输入的潜力 -->
	<select id="getDoctorPotentialList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.set.DoctorPotentialResponseBean">
		SELECT
						v2.dynamic_field_value potential,
						v2.doctor_id doctorId
					FROM
						virtual_doctor_dynamic_field v1
					INNER JOIN virtual_doctor_dynamic_field_value v2 ON v1.id = v2.dynamic_field_id
					WHERE
						v2.doctor_id IN
						<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
						#{doctorId}
						</foreach>
					AND v1.product_id IN
					<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
						#{productId}
					</foreach>
					AND v1.extend_type = 1
		GROUP BY v2.doctor_id

	</select>

	<!-- 得到医生输入的分型 -->
	<select id="getDoctorClassificationList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.set.DoctorClassificationResponseBean">
		SELECT
						v2.dynamic_field_value classification,
						v2.doctor_id doctorId
					FROM
						virtual_doctor_dynamic_field v1
					INNER JOIN virtual_doctor_dynamic_field_value v2 ON v1.id = v2.dynamic_field_id
					WHERE
						v2.doctor_id IN
						<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
							#{doctorId}
						</foreach>
					AND v1.product_id IN
					<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
						#{productId}
					</foreach>
					AND v1.extend_type = 2
		GROUP BY v2.doctor_id

	</select>



	<!-- 到设定了拜访频次要拜访的医生列表 -->
	<select id="getVisitFrequencyDayDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.plan.VisitDoctorResponseBean">

		SELECT
		DATE_FORMAT(
		max(v.create_time),
		'%Y-%m-%d'
		) AS maxVisitTime,
		DATEDIFF(NOW(), max(v.create_time)) AS days,
		virtual_doctor_id doctorId
		FROM
		virtual_doctor_call_info v
		WHERE
		virtual_drug_user_id IN

		<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
			#{virtualDrugUserId}
		</foreach>

		GROUP BY
		v.virtual_doctor_id
		HAVING
		days >= (
			SELECT min(visit_frequency) FROM virtual_product_visit_frequency
			WHERE product_id IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>
		)
		ORDER BY
		days DESC
	</select>


	<!-- 到设定了拜访频次要拜访的医生列表 -->
	<select id="getRetVisitFrequencyDayDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.plan.VisitDoctorResponseBean">

		SELECT
			DATE_FORMAT(dud.maxCreateTime, '%Y-%m-%d') AS maxVisitTime,
			DATEDIFF(NOW(), dud.maxCreateTime) AS days,
		 dud.doctorId
		FROM
			(
				SELECT
					dud.doctor_id doctorId,
					max(dud.modify_time) AS maxCreateTime
				FROM
					drug_user_doctor dud
				INNER JOIN doctor d ON dud.doctor_id = d.id
				WHERE
					dud.is_available = 1
				AND dud.drug_user_id IN

					<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
						#{virtualDrugUserId}
					</foreach>
				AND dud.prod_id IN
					<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
						#{productLineId}
					</foreach>
				GROUP BY
					dud.doctor_id
			) dud
		LEFT JOIN virtual_doctor_call_info v ON dud.doctorId = v.virtual_doctor_id
		WHERE
			v.id IS NULL
		<!-- 没有拜访的都是满足的
		HAVING days >= (
		SELECT min(ret_visit_frequency) FROM virtual_product_visit_frequency
		WHERE product_id IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>

		)
		-->
	</select>


	<!-- 得到设定了会前拜访的医生列表,单位天 -->
	<select id="getBeforeMeetingDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.plan.VisitDoctorResponseBean">
		SELECT
		tmad.doctor_id doctorId,
		round(
		(
		UNIX_TIMESTAMP(m.start_time) - UNIX_TIMESTAMP(NOW())
		) / 60
		) AS overMinute,
		m.start_time maxVisitTime,
		(
		SELECT
		min(
		before_meeting_frequency
		)
		FROM
		virtual_product_visit_frequency
		WHERE
		product_id
		IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>
		) as frequency
		FROM
		t_meeting_attend_details tmad
		INNER JOIN (
		SELECT
		id,
		tma.start_time
		FROM
		t_meeting_data tma
		WHERE
		DATE_FORMAT(tma.start_time, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d')
		AND tma.product_id
		) m ON tmad.meeting_id = m.id
		LEFT JOIN virtual_meeting_no_remind r ON m.id = r.meeting_id
		WHERE
		r.id IS NULL
		HAVING overMinute &gt;=0 AND
		overMinute &lt;=(
		SELECT
		min(
			before_meeting_frequency * 24 * 60
		)
		FROM
		virtual_product_visit_frequency
		WHERE
		product_id
		IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>
		)

	</select>

	<!-- 得到设定了会后拜访的医生列表,单位天 -->
	<select id="getAfterMeetingDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.plan.VisitDoctorResponseBean">
		SELECT
			DATEDIFF(NOW(), tmd.end_time) AS days,
			MAX(tmd.end_time) maxVisitTime,
			tmad.doctor_id doctorId,
			(
			SELECT
			min(
			after_meeting_frequency
			)
			FROM
			virtual_product_visit_frequency
			WHERE
			product_id
			IN
			<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
				#{productLineId}
			</foreach>
			) as frequency
		FROM
			t_meeting_data tmd
		INNER JOIN t_meeting_attend_details tmad ON tmd.id = tmad.doctor_id
		INNER JOIN drug_user_doctor dud ON tmad.doctor_id = dud.doctor_id
		AND is_available = 1
		WHERE
			dud.drug_user_id IN
		<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
			#{virtualDrugUserId}
		</foreach>

		AND dud.prod_id IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>
		GROUP BY
			tmad.doctor_id
		HAVING
		days >= (
		SELECT
		min(
		after_meeting_frequency
		)
		FROM
		virtual_product_visit_frequency
		WHERE
		product_id
		IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>
		)
		AND tmad.doctor_id NOT IN (
			SELECT DISTINCT
				virtual_doctor_id
			FROM
				virtual_doctor_call_info
			WHERE
				virtual_drug_user_id IN

		<foreach collection="virtualDrugUserIds" item="virtualDrugUserId" open="(" close=")" separator=",">
			#{virtualDrugUserId}
		</foreach>
			AND product_id IN
		<foreach collection="productLineIds" item="productLineId" open="(" close=")" separator=",">
			#{productLineId}
		</foreach>
			AND create_time >= MAX(tmd.end_time)
		)
	</select>

	<select id="selectDoctorByMobiles" resultType="com.nuoxin.virtual.rep.api.entity.Doctor">
		select t.id,t.email,t.name,t.hospital_id hospitalId,t.hospital_name hospitalName,
		t.provice,t.city,t.depart department,t.telephone mobile,t.positions doctorLevel,
		t.create_time createTime,t.status,t.master_data_id masterDataId
		FROM doctor t
		LEFT JOIN doctor_telephone dt
		ON t.id=dt.doctor_id
		WHERE
		dt.telephone IN
		<foreach collection="mobiles" item="mobile" open="(" close=")" separator=",">
			#{mobile}
		</foreach>
		GROUP BY t.id

	</select>

	<insert id="saveDoctor" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO doctor
		( email, name, sex,hospital_id,hospital_name,provice,city,depart,telephone,positions,create_time,status,master_data_id)
		VALUES
		( #{email}, #{name},#{sex}, #{hospitalId}, #{hospitalName}, #{province}, #{city}, #{department}, #{mobile}, #{doctorLevel},now(),1,#{masterDataId})
	</insert>

	<update id="updateDoctor" >
		UPDATE doctor
		<trim prefix="set" suffixOverrides=",">
			<if test="email !=null and email !=''">
				email=#{email},
			</if>
			<if test="name !=null and name !=''">
				name=#{name},
			</if>
			<if test="hospitalId !=null and hospitalId !=0 and hospitalName !=null and hospitalName !=''">
				hospital_id=#{hospitalId}, hospital_name=#{hospitalName},
			</if>
			<!--
			<if test="hospitalName !=null and hospitalName !=''">
				hospital_name=#{hospitalName},
			</if>
			-->
			<if test="province !=null and province !=''">
				provice=#{province},
			</if>
			<if test="city !=null and city !=''">
				city=#{city},
			</if>
			<if test="department !=null and department !=''">
				depart=#{department},
			</if>
			<if test="mobile !=null and mobile !=''">
				telephone=#{mobile},
			</if>
			<if test="sex !=null">
				sex=#{sex},
			</if>
			<if test="doctorLevel !=null ">
				positions=#{doctorLevel},
			</if>
			<if test="masterDataId !=null ">
				master_data_id=#{masterDataId},
			</if>
		</trim>
		WHERE id=#{id}
	</update>


	<select id="doctorCountByMobile" resultType="java.lang.Integer">
		SELECT sum(num) FROM (
		SELECT COUNT(*) num FROM doctor WHERE telephone=#{mobile}
		UNION
		SELECT COUNT(*) num FROM doctor_telephone WHERE telephone=#{mobile}
		) t
	</select>

	<select id="doctorNameCountByMobile" resultType="java.lang.String">
		SELECT DISTINCT d.name FROM doctor d
		WHERE d.telephone=#{mobile}
		OR d.id IN
		(
	  SELECT DISTINCT doctor_id FROM doctor_telephone WHERE telephone=#{mobile}

		)
	</select>

	<!-- 保存医生的多个手机号 -->
	<insert id="insertDoctorTelephone">
		INSERT INTO doctor_telephone(doctor_id, telephone, type)
		VALUES
		<foreach collection="list" item="d" separator=",">
			(#{d.doctorId}, #{d.telephone}, #{d.type})
		</foreach>
	</insert>

	<select id="doctorProductInfo" resultType="com.nuoxin.virtual.rep.api.web.controller.response.call.CallDoctorResponseBean">
		SELECT t.id AS doctorId,t.name,t.telephone mobile,t.`positions` title,
		t1.`name` hospital,t1.`level` AS hospitalLevel,t.subdivision_depart AS department
		FROM doctor t
		LEFT JOIN hospital t1 ON t.hospital_id=t1.`id`
		WHERE t.id=#{doctorId}
	</select>

	<!-- 得到医生的联系方式 -->
	<select id="getDoctorTelephone" resultType="java.lang.String">
		SELECT telephone FROM doctor WHERE id=#{doctorId} AND LEFT(telephone, 1)=1
		UNION
		SELECT telephone FROM doctor_telephone WHERE doctor_id=#{doctorId}
	</select>

	<!-- 删除医生的多个联系方式 -->
	<delete id="deleteDoctorTelephone">
		DELETE FROM doctor_telephone WHERE doctor_id=#{doctorId}
	</delete>

	<!-- 查询总数，用于校验医生是否在指定产品下 -->
	<select id="doctorProductCount" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM drug_user_doctor WHERE doctor_id=#{doctorId} AND prod_id=#{productId}
		AND is_available=1
	</select>

	<!-- 根据联系方式获取医生列表 -->
	<select id="getDoctorListByTelephone" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.DoctorDetailsResponseBean">
		SELECT DISTINCT
			d.id doctorId,
			d.`name` doctorName,
			h.id hospitalId,
			d.hospital_name hospitalName,
			h.`level` hospitalLevel,
			h.province,
			h.city,
			d.depart department
		FROM
			doctor d
		LEFT JOIN hospital h ON d.hospital_id = h.id
		WHERE
			d.id IN (
				SELECT
					id
				FROM
					doctor
				WHERE
					telephone = #{telephone}
				UNION
					SELECT
						doctor_id
					FROM
						doctor_telephone
					WHERE
						telephone = #{telephone}
			)
	</select>



	<!-- 根据多个联系方式获取详情 -->
	<select id="getDoctorListByTelephones" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.DoctorDetailsResponseBean">

		<!--
		SELECT DISTINCT
			d.id doctorId,
			d.`name` doctorName,
			d.sex,
			dm.wechat,
			dm.address,
			d.email,
			h.id hospitalId,
			d.hospital_name hospitalName,
			h.`level` hospitalLevel,
			h.province,
			h.city,
			d.depart department,
			d.positions,
			IFNULL(dudoto.is_add_wechat, 0) addWechat
		FROM
			doctor d
		LEFT JOIN hospital h ON d.hospital_id = h.id
		LEFT JOIN doctor_mend dm
		ON d.id=dm.virtual_doctor_id
		LEFT JOIN drug_user_doctor_one_to_one dudoto
		ON  dudoto.doctor_id=d.id
		AND dudoto.drug_user_id=#{drugUserId}
		WHERE
			d.id IN (
				SELECT
					id
				FROM
					doctor
				WHERE
					telephone IN
					<foreach collection="telephones" item="telephone" open="(" close=")" separator=",">
						#{telephone}
					</foreach>
				UNION
					SELECT
						doctor_id
					FROM
						doctor_telephone
					WHERE
						telephone IN
						<foreach collection="telephones" item="telephone" open="(" close=")" separator=",">
							#{telephone}
						</foreach>
			)
        -->





		SELECT
		d.id doctorId,
		d.`name` doctorName,
		d.sex,
		dm.wechat,
		dm.address,
		d.email,
		h.id hospitalId,
		d.hospital_name hospitalName,
		h.`level` hospitalLevel,
		h.province,
		h.city,
		d.depart department,
		d.positions
		FROM
		doctor d
		LEFT JOIN hospital h ON d.hospital_id = h.id
		LEFT JOIN doctor_mend dm
		ON d.id=dm.virtual_doctor_id
		LEFT JOIN doctor_telephone dt
		ON d.id=dt.doctor_id
		WHERE
		dt.telephone IN

		<foreach collection="telephones" item="telephone" open="(" close=")" separator=",">
			#{telephone}
		</foreach>

		GROUP BY d.id




	</select>


	<!-- 根据医生姓名和医院获取详情 -->
	<select id="getDoctorListByName" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.DoctorDetailsResponseBean">
			SELECT DISTINCT
				d.id doctorId,
				d.`name` doctorName,
				d.sex,
				dm.wechat,
				dm.address,
				d.email,
				h.id hospitalId,
				d.hospital_name hospitalName,
				h.`level` hospitalLevel,
				h.province,
				h.city,
				d.depart department,
				d.positions
			FROM
				doctor d
			LEFT JOIN hospital h ON d.hospital_id = h.id
			LEFT JOIN doctor_mend dm
			ON d.id=dm.virtual_doctor_id
			WHERE d.hospital_name=#{hospitalName}
			AND d.name=#{doctorName}
			GROUP BY d.id
	</select>

	<select id="getDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.DoctorDetailsResponseBean">
		SELECT DISTINCT
		d.id doctorId,
		d.name doctorName,
		d.hospital_name hospitalName
		FROM doctor d
		INNER JOIN drug_user_doctor dud
		ON d.id=dud.doctor_id
		INNER JOIN drug_user du
		ON dud.drug_user_id=du.id
		WHERE dud.is_available=1
		AND dud.prod_id=#{productId}
		AND d.name LIKE CONCAT('%', #{doctorName}, '%')
		AND du.id IN
		<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
			#{drugUserId}
		</foreach>

		LIMIT #{limitNum}

	</select>


	<select id="getDoctorCount" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM doctor
		WHERE name=#{doctorName}
		AND hospital_name=#{hospitalName}
	</select>


	<!-- V3.0.1 相关接口  -->

	<!-- 我的客户基本信息列表 -->
	<select id="getMyDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.MyDoctorResponse">

		SELECT
		d.id doctorId,
		d.NAME doctorName,
		(
		CASE

		WHEN d.sex IS NULL THEN
		'未知'
		WHEN d.sex = 0 THEN
		'男'
		WHEN d.sex = 1 THEN
		'女' ELSE '未知'
		END
		) AS sex,
		d.depart,
		d.positions,
		d.hospital_id hospitalId,
		d.hospital_name hospitalName,
		h.province,
		h.city,
		h.level hospitalLevel,
		du.id drugUserId,
		du.NAME drugUserName,
		pl.prod_id productId,
		pl.prod_name productName,
		(
		CASE

		WHEN q.is_target IS NULL THEN
		'未知'
		WHEN q.is_target = 0 THEN
		'否'
		WHEN q.is_target = 1 THEN
		'是' ELSE '未知'
		END
		) AS target,
		(
		CASE

		WHEN q.is_recruit IS NULL THEN
		'暂未招募'
		WHEN q.is_recruit = 0 THEN
		'招募失败'
		WHEN q.is_recruit = 1 THEN
		'成功招募' ELSE '暂未招募'
		END
		) AS recruit,
		(
		CASE

		WHEN q.is_has_drug IS NULL THEN
		'未知'
		WHEN q.is_has_drug = 0 THEN
		'否'
		WHEN q.is_has_drug = 1 THEN
		'是'
		WHEN q.is_has_drug = 2 THEN
		'临采' ELSE '未知'
		END
		) AS hasDrug,

		(
		CASE

		WHEN q.is_has_ae IS NULL THEN
		'未知'
		WHEN q.is_has_ae = 0 THEN
		'否'
		WHEN q.is_has_ae = 1 THEN
		'是'
		ELSE '未知'
		END
		) AS hasAe,

		(
		CASE

		WHEN q.is_cover IS NULL THEN
		'其他'
		WHEN q.is_cover = 0 THEN
		'未开始'
		WHEN q.is_cover = 1 THEN
		'覆盖中'
		WHEN q.is_cover = 2 THEN
		'退出项目' ELSE '其他'
		END
		) AS cover ,


		(
		CASE

		WHEN q.hcp_potential IS NULL THEN
		'未知'
		WHEN q.hcp_potential = 1 THEN
		'低'
		WHEN q.hcp_potential = 2 THEN
		'中'
		WHEN q.hcp_potential = 3 THEN
		'高' ELSE '未知'
		END
		) AS potential ,

		q.attitude,
		IFNULL(GROUP_CONCAT(DISTINCT re.visit_result), '') visitResult,
		max(v.create_time) lastVisitDate,
		max(v.id) maxVisitId
		FROM
		doctor d
		LEFT JOIN hospital h
		ON d.hospital_id=h.id
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN product_line pl ON dud.prod_id = pl.prod_id
		LEFT JOIN product_doctor_quate q
		ON dud.doctor_id = q.doctor_id
		AND dud.prod_id = q.product_id
		LEFT JOIN product_doctor_quate_result r
		ON r.quate_id=q.id
		LEFT JOIN virtual_product_visit_result re
		ON r.result_id=re.id


		LEFT JOIN virtual_doctor_call_info v
		ON v.virtual_doctor_id=dud.doctor_id
		AND v.product_id=dud.prod_id

		LEFT JOIN virtual_doctor_call_info_mend m
		ON v.id=m.call_id

		<!-- 需要会议回访 -->
		<if test="tag !=null and tag==1">
			INNER JOIN (
			SELECT DISTINCT
			tmad.doctor_id
			FROM
			t_meeting_data tmd
			INNER JOIN t_meeting_attend_details tmad ON tmd.id = tmad.meeting_id
			INNER JOIN drug_user_doctor dud ON tmad.doctor_id = dud.doctor_id
			LEFT JOIN virtual_doctor_call_info v1
			ON v1.virtual_doctor_id=dud.doctor_id AND v1.virtual_drug_user_id=dud.drug_user_id AND v1.product_id=dud.prod_id
			WHERE
			dud.is_available = 1
			AND v1.id IS NULL

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND dud.drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>


			<if test="productIdList !=null and productIdList.size > 0">
				AND dud.prod_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			AND (

			<if test="productIdList !=null and productIdList.size > 0">
				tmd.product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			OR tmd.item_id IN ( SELECT id FROM drug_product WHERE 1=1

			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
			)
			) meeting_dud
			ON d.id=meeting_dud.doctor_id
		</if>


		<!-- 阅读过文章但未拜访 -->
		<if test="tag !=null and tag ==4">
			INNER JOIN (
			SELECT DISTINCT
			read_person_id
			FROM
			drug_user_doctor dud
			INNER JOIN activity_read ar ON dud.doctor_id = ar.read_person_id
			AND dud.drug_user_id = ar.drug_user_id
			LEFT JOIN virtual_doctor_call_info v1
			ON v1.virtual_drug_user_id=dud.drug_user_id AND v1.virtual_doctor_id=dud.doctor_id AND v1.product_id=dud.prod_id

			WHERE
			dud.is_available = 1
			AND v1.id IS NULL

			<if test="productIdList !=null and productIdList.size > 0">
				AND dud.prod_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND dud.drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>

			AND ar.data_id IN ( SELECT DISTINCT content_id FROM t_content_product WHERE 1=1
			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
			) content_dud
			ON d.id=content_dud.read_person_id
		</if>



		WHERE
		dud.is_available = 1
		<if test="drugUserIdList !=null and drugUserIdList.size > 0">
			AND dud.drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

		<if test="productIdList !=null and productIdList.size > 0">
			AND dud.prod_id IN
			<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
				#{productId}
			</foreach>
		</if>


		<!-- 下次拜访时间为今天 -->
		<if test="tag !=null and tag==5">
			AND DATE_FORMAT(m.next_visit_time, '%Y-%m-%d')=CURRENT_DATE()
		</if>

		<!-- 最近一次未接通 -->
		<if test="tag !=null and tag==6">
			AND v.id = (SELECT MAX(id) FROM virtual_doctor_call_info WHERE
			status_name IN ('poweroff','reject','emptynumber', 'busy', 'stop', 'noanswer' )

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND virtual_drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>

			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
		</if>


		<if test="recruit !=null">
			<if test="recruit==1 or recruit == 0">
				AND q.is_recruit=#{recruit}
			</if>

			<if test="recruit!=1 and recruit != 0">
				AND (q.is_recruit IS NULL OR q.is_recruit=#{recruit} OR q.is_recruit=2)
			</if>

		</if>

		<if test="cover !=null">
			<if test="cover == 0 or cover == 1 or cover==2">
				AND q.is_cover=#{cover}
			</if>

			<if test="cover != 0 and cover != 1 and cover!=2">
				AND (q.is_cover IS NULL OR q.is_cover=#{cover})
			</if>
		</if>

		<if test="target !=null">

			<if test="target==0 or target ==1">
				AND q.is_target =#{target}
			</if>

			<if test="target!=0 and target !=1">
				AND (q.is_target IS NULL OR q.is_target =#{target})
			</if>


		</if>

		<if test="hasDrug!=null">
			<if test="hasDrug == 0 or hasDrug==1 or hasDrug==2">
				AND q.is_has_drug=#{hasDrug}
			</if>

			<if test="hasDrug != 0 and hasDrug!=1 and hasDrug!=2">
				AND (q.is_has_drug IS NULL OR q.is_has_drug=#{hasDrug})
			</if>
		</if>

		<if test="searchKeyword !=null and searchKeyword !=''">
			AND d.id IN
			(
			SELECT
			id
			FROM
			doctor
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
			OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
			OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT
			doctor_id
			FROM
			doctor_telephone
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT #{searchKeyword}
			)
		</if>

		<!-- 需要会议回访的 -->
		<if test="tag !=null and tag==1">
			AND v.id IS NULL
		</if>

		<!-- 新转入医生 -->
		<if test="tag !=null and tag==2">
			AND v.id IS NULL
		</if>

		<!-- 阅读过文章但未拜访 -->
		<!--
		<if test="tag !=null and tag==4">
			AND v.id IS NULL
		</if>
		-->


		GROUP BY
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id
		<!-- 超过10天未拜访 -->
		<if test="tag !=null and tag==3">
		  HAVING (TO_DAYS(NOW())-TO_DAYS(MAX(v.create_time))) > 10
		</if>


		<if test="lastVisitTimeOrder !=null and lastVisitTimeOrder=='down'">
			ORDER BY max(v.id) DESC
		</if>

		<if test="lastVisitTimeOrder !=null and lastVisitTimeOrder=='up'">
			ORDER BY max(v.id)
		</if>


		LIMIT #{currentSize}, #{pageSize}

	</select>


	<!-- 我的客户基本信息列表 -->
	<select id="getMyDoctorListCount" resultType="java.lang.Integer">

		SELECT IFNULL(COUNT(*),0) FROM (
		SELECT
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id
		FROM
		doctor d
		INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN product_line pl ON dud.prod_id = pl.prod_id
		LEFT JOIN
		product_doctor_quate q
		ON dud.doctor_id = q.doctor_id
		AND dud.prod_id = q.product_id
		LEFT JOIN product_doctor_quate_result r
		ON r.quate_id=q.id
		LEFT JOIN virtual_product_visit_result re
		ON r.result_id=re.id
		LEFT JOIN virtual_doctor_call_info v
		ON v.virtual_doctor_id=dud.doctor_id
		AND v.product_id=dud.prod_id

		LEFT JOIN virtual_doctor_call_info_mend m
		ON v.id=m.call_id

		<!-- 需要会议回访 -->
		<if test="tag !=null and tag==1">
			INNER JOIN (
			SELECT DISTINCT
			tmad.doctor_id
			FROM
			t_meeting_data tmd
			INNER JOIN t_meeting_attend_details tmad ON tmd.id = tmad.meeting_id
			INNER JOIN drug_user_doctor dud ON tmad.doctor_id = dud.doctor_id
			LEFT JOIN virtual_doctor_call_info v1
			ON v1.virtual_doctor_id=dud.doctor_id AND v1.virtual_drug_user_id=dud.drug_user_id AND v1.product_id=dud.prod_id
			WHERE
			dud.is_available = 1
			AND v1.id IS NULL

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND dud.drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>


			<if test="productIdList !=null and productIdList.size > 0">
				AND dud.prod_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			AND (

			<if test="productIdList !=null and productIdList.size > 0">
				tmd.product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			OR tmd.item_id IN ( SELECT id FROM drug_product WHERE 1=1

			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
			)
			) meeting_dud
			ON d.id=meeting_dud.doctor_id
		</if>


		<!-- 阅读过文章但未拜访 -->
		<if test="tag !=null and tag ==4">
			INNER JOIN (
			SELECT DISTINCT
			read_person_id
			FROM
			drug_user_doctor dud
			INNER JOIN activity_read ar ON dud.doctor_id = ar.read_person_id
			AND dud.drug_user_id = ar.drug_user_id
			LEFT JOIN virtual_doctor_call_info v1
			ON v1.virtual_drug_user_id=dud.drug_user_id AND v1.virtual_doctor_id=dud.doctor_id AND v1.product_id=dud.prod_id


			WHERE
			dud.is_available = 1
			AND v1.id IS NULL
			<if test="productIdList !=null and productIdList.size > 0">
				AND dud.prod_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND dud.drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>

			AND ar.data_id IN ( SELECT DISTINCT content_id FROM t_content_product WHERE 1=1
			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
			) content_dud
			ON d.id=content_dud.read_person_id
		</if>



		WHERE
		dud.is_available = 1
		<if test="drugUserIdList !=null and drugUserIdList.size > 0">
			AND dud.drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>


		<if test="productIdList !=null and productIdList.size > 0">
			AND dud.prod_id IN
			<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
				#{productId}
			</foreach>

		</if>

		<!-- 下次拜访时间为今天 -->
		<if test="tag !=null and tag==5">
			AND DATE_FORMAT(m.next_visit_time, '%Y-%m-%d')=CURRENT_DATE()
		</if>


		<!-- 最近一次未接通 -->
		<if test="tag !=null and tag==6">
			AND v.id = (SELECT MAX(id) FROM virtual_doctor_call_info WHERE
			status_name IN ('poweroff','reject','emptynumber', 'busy', 'stop', 'noanswer' )

			<if test="drugUserIdList !=null and drugUserIdList.size > 0">
				AND virtual_drug_user_id IN
				<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
					#{drugUserId}
				</foreach>
			</if>

			<if test="productIdList !=null and productIdList.size > 0">
				AND product_id IN
				<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
					#{productId}
				</foreach>
			</if>

			)
		</if>


		<if test="recruit !=null">
			<if test="recruit==1 or recruit == 0">
				AND q.is_recruit=#{recruit}
			</if>

			<if test="recruit!=1 and recruit != 0">
				AND (q.is_recruit IS NULL OR q.is_recruit=#{recruit} OR q.is_recruit=2)
			</if>

		</if>

		<if test="cover !=null">
			<if test="cover == 0 or cover == 1 or cover==2">
				AND q.is_cover=#{cover}
			</if>

			<if test="cover != 0 and cover != 1 and cover!=2">
				AND (q.is_cover IS NULL OR q.is_cover=#{cover})
			</if>
		</if>

		<if test="target !=null">

			<if test="target==0 or target ==1">
				AND q.is_target =#{target}
			</if>

			<if test="target!=0 and target !=1">
				AND (q.is_target IS NULL OR q.is_target =#{target})
			</if>


		</if>

		<if test="hasDrug!=null">
			<if test="hasDrug == 0 or hasDrug==1 or hasDrug==2">
				AND q.is_has_drug=#{hasDrug}
			</if>

			<if test="hasDrug != 0 and hasDrug!=1 and hasDrug!=2">
				AND (q.is_has_drug IS NULL OR q.is_has_drug=#{hasDrug})
			</if>
		</if>



		<if test="searchKeyword !=null and searchKeyword !=''">
			AND d.id IN
			(
			SELECT
			id
			FROM
			doctor
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
			OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
			OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT
			doctor_id
			FROM
			doctor_telephone
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT #{searchKeyword}
			)
		</if>

		<!-- 需要会议回访的 -->
		<if test="tag !=null and tag==1">
			AND v.id IS NULL
		</if>

		<!-- 新转入医生 -->
		<if test="tag !=null and tag==2">
			AND v.id IS NULL
		</if>

		<!-- 阅读过文章但未拜访 -->

		<!--
		<if test="tag !=null and tag==4">
			AND v.id IS NULL
		</if>
		-->


		GROUP BY
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id
		<!-- 超过10天未拜访 -->
		<if test="tag !=null and tag==3">
			HAVING (TO_DAYS(NOW())-TO_DAYS(MAX(v.create_time))) > 10
		</if>

		) t

	</select>

	<!-- 公共池医生列表 -->
	<select id="getCommonPoolDoctorList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.CommonPoolDoctorResponse">
		SELECT
		d.id doctorId,
		d.NAME doctorName,
		(
		CASE

		WHEN d.sex IS NULL THEN
		'未知'
		WHEN d.sex = 0 THEN
		'男'
		WHEN d.sex = 1 THEN
		'女' ELSE '未知'
		END
		) AS sex,
		d.depart,
		d.positions,
		d.hospital_id hospitalId,
		d.hospital_name hospitalName,
		h.province,
		h.city,
		h.level hospitalLevel,
		IF(dud.is_available=1, du.id, 0) drugUserId,
		IF(dud.is_available=1, du.NAME, '无') drugUserName,
		pl.prod_id productId,
		pl.prod_name productName,
		(
		CASE

		WHEN q.is_target IS NULL THEN
		'未知'
		WHEN q.is_target = 0 THEN
		'否'
		WHEN q.is_target = 1 THEN
		'是' ELSE '未知'
		END
		) AS target,
		(
		CASE

		WHEN q.is_recruit IS NULL THEN
		'暂未招募'
		WHEN q.is_recruit = 0 THEN
		'招募失败'
		WHEN q.is_recruit = 1 THEN
		'成功招募' ELSE '暂未招募'
		END
		) AS recruit,
		(
		CASE

		WHEN q.is_has_drug IS NULL THEN
		'未知'
		WHEN q.is_has_drug = 0 THEN
		'否'
		WHEN q.is_has_drug = 1 THEN
		'是'
		WHEN q.is_has_drug = 2 THEN
		'临采' ELSE '未知'
		END
		) AS hasDrug,

		(
		CASE

		WHEN q.is_has_ae IS NULL THEN
		'未知'
		WHEN q.is_has_ae = 0 THEN
		'否'
		WHEN q.is_has_ae = 1 THEN
		'是'
		ELSE '未知'
		END
		) AS hasAe,

		(
		CASE

		WHEN q.is_cover IS NULL THEN
		'未知'
		WHEN q.is_cover = 0 THEN
		'未开始'
		WHEN q.is_cover = 1 THEN
		'覆盖中'
		WHEN q.is_cover = 2 THEN
		'退出项目' ELSE '未知'
		END
		) AS cover ,

		(
		CASE

		WHEN q.hcp_potential IS NULL THEN
		'未知'
		WHEN q.hcp_potential = 1 THEN
		'低'
		WHEN q.hcp_potential = 2 THEN
		'中'
		WHEN q.hcp_potential = 3 THEN
		'高' ELSE '未知'
		END
		) AS potential ,

		q.attitude,
		max(v.create_time) lastVisitDate,
		IFNULL(GROUP_CONCAT(DISTINCT re.visit_result),'') visitResult,
		max(v.id) maxVisitId
		FROM
		doctor d
		LEFT JOIN hospital h
		ON d.hospital_id=h.id

		INNER JOIN drug_user_doctor dud

		ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN product_line pl ON dud.prod_id = pl.prod_id
		LEFT JOIN


		product_doctor_quate q
		ON dud.doctor_id = q.doctor_id
		AND dud.prod_id = q.product_id
		LEFT JOIN product_doctor_quate_result r
		ON r.quate_id=q.id
		LEFT JOIN virtual_product_visit_result re
		ON r.result_id=re.id



		LEFT JOIN virtual_doctor_call_info v
		ON v.virtual_doctor_id=dud.doctor_id
		AND v.product_id=dud.prod_id
		WHERE
		1 = 1
		<if test="drugUserIdList !=null and drugUserIdList.size > 0">
			AND dud.drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

		<if test="productIdList !=null and productIdList.size > 0">
			AND dud.prod_id IN
			<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
				#{productId}
			</foreach>
		</if>



		<if test="recruit !=null">
			<if test="recruit==1 or recruit == 0">
				AND q.is_recruit=#{recruit}
			</if>

			<if test="recruit!=1 and recruit != 0">
				AND (q.is_recruit IS NULL OR q.is_recruit=#{recruit} OR q.is_recruit=2)
			</if>

		</if>

		<if test="cover !=null">
			<if test="cover == 0 or cover == 1 or cover==2">
				AND q.is_cover=#{cover}
			</if>

			<if test="cover != 0 and cover != 1 and cover!=2">
				AND (q.is_cover IS NULL OR q.is_cover=#{cover})
			</if>
		</if>

		<if test="target !=null">

			<if test="target==0 or target ==1">
				AND q.is_target =#{target}
			</if>

			<if test="target!=0 and target !=1">
				AND (q.is_target IS NULL OR q.is_target =#{target})
			</if>


		</if>

		<if test="hasDrug!=null">
			<if test="hasDrug == 0 or hasDrug==1 or hasDrug==2">
				AND q.is_has_drug=#{hasDrug}
			</if>

			<if test="hasDrug != 0 and hasDrug!=1 and hasDrug!=2">
				AND (q.is_has_drug IS NULL OR q.is_has_drug=#{hasDrug})
			</if>
		</if>



		<if test="relationDrugUser !=null">
			AND dud.is_available=#{relationDrugUser}
		</if>

		<if test="searchKeyword !=null and searchKeyword !=''">
			AND d.id IN
			(
			SELECT
			id
			FROM
			doctor
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
			OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
			OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT
			doctor_id
			FROM
			doctor_telephone
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT #{searchKeyword}
			)
		</if>

		GROUP BY
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id

		<if test="lastVisitTimeOrder !=null and lastVisitTimeOrder=='down'">
			ORDER BY max(v.id) DESC
		</if>

		<if test="lastVisitTimeOrder !=null and lastVisitTimeOrder=='up'">
			ORDER BY max(v.id)
		</if>



		<if test="paginable == null or paginable == 0">
			LIMIT #{currentSize}, #{pageSize}
		</if>


	</select>

	<!-- 公共池医生列表总数 -->
	<select id="getCommonPoolDoctorListCount" resultType="java.lang.Integer">
		SELECT IFNULL(COUNT(*), 0) FROM (
		SELECT
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id
		FROM
		doctor d

		INNER JOIN drug_user_doctor dud

		ON d.id = dud.doctor_id
		INNER JOIN drug_user du ON dud.drug_user_id = du.id
		INNER JOIN product_line pl ON dud.prod_id = pl.prod_id
		LEFT JOIN
		product_doctor_quate q
		ON dud.doctor_id = q.doctor_id
		AND dud.prod_id = q.product_id
		LEFT JOIN product_doctor_quate_result r
		ON r.quate_id=q.id
		LEFT JOIN virtual_product_visit_result re
		ON r.result_id=re.id




		LEFT JOIN virtual_doctor_call_info v
		ON v.virtual_doctor_id=dud.doctor_id
		AND v.product_id=dud.prod_id
		WHERE
		1 = 1
		<if test="drugUserIdList !=null and drugUserIdList.size > 0">
			AND dud.drug_user_id IN
			<foreach collection="drugUserIdList" item="drugUserId" open="(" close=")" separator=",">
				#{drugUserId}
			</foreach>
		</if>

		<if test="productIdList !=null and productIdList.size > 0">
			AND dud.prod_id IN
			<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
				#{productId}
			</foreach>
		</if>


		<if test="recruit !=null">
			<if test="recruit==1 or recruit == 0">
				AND q.is_recruit=#{recruit}
			</if>

			<if test="recruit!=1 and recruit != 0">
				AND (q.is_recruit IS NULL OR q.is_recruit=#{recruit} OR q.is_recruit=2)
			</if>

		</if>

		<if test="cover !=null">
			<if test="cover == 0 or cover == 1 or cover==2">
				AND q.is_cover=#{cover}
			</if>

			<if test="cover != 0 and cover != 1 and cover!=2">
				AND (q.is_cover IS NULL OR q.is_cover=#{cover})
			</if>
		</if>

		<if test="target !=null">

			<if test="target==0 or target ==1">
				AND q.is_target =#{target}
			</if>

			<if test="target!=0 and target !=1">
				AND (q.is_target IS NULL OR q.is_target =#{target})
			</if>


		</if>

		<if test="hasDrug!=null">
			<if test="hasDrug == 0 or hasDrug==1 or hasDrug==2">
				AND q.is_has_drug=#{hasDrug}
			</if>

			<if test="hasDrug != 0 and hasDrug!=1 and hasDrug!=2">
				AND (q.is_has_drug IS NULL OR q.is_has_drug=#{hasDrug})
			</if>
		</if>




		<if test="relationDrugUser !=null">
			AND dud.is_available=#{relationDrugUser}
		</if>


		<if test="searchKeyword !=null and searchKeyword !=''">
			AND d.id IN
			(
			SELECT
			id
			FROM
			doctor
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			OR NAME LIKE CONCAT('%', #{searchKeyword}, '%')
			OR hospital_name LIKE CONCAT('%', #{searchKeyword}, '%')
			OR depart LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT
			doctor_id
			FROM
			doctor_telephone
			WHERE
			telephone LIKE CONCAT('%', #{searchKeyword}, '%')
			UNION
			SELECT #{searchKeyword}
			)
		</if>

		GROUP BY
		dud.drug_user_id,
		dud.doctor_id,
		dud.prod_id
		) t


	</select>



	<!-- 得到医生的拜访结果 -->
	<select id="getLastDoctorVisitList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.DoctorVisitResponse">

		SELECT
		du.id visitDrugUserId,
		du.name visitDrugUserName,
		a.virtual_doctor_id doctorId,
		a.product_id productId,
		b.lastVisitTime
		FROM virtual_doctor_call_info a INNER JOIN (
		SELECT
		max(v.create_time) lastVisitTime,
		max(v.id) maxVisitId,
		v.virtual_doctor_id,
		v.product_id
		FROM
		virtual_doctor_call_info v
		INNER JOIN drug_user du
		ON v.virtual_drug_user_id=du.id
		WHERE
		v.virtual_doctor_id IN
		<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
			#{doctorId}
		</foreach>

		AND v.product_id IN
		<foreach collection="productIdList" item="productId" open="(" close=")" separator=",">
			#{productId}
		</foreach>
		GROUP BY
		v.virtual_doctor_id,v.product_id
		) b
		ON a.virtual_doctor_id=b.virtual_doctor_id AND a.product_id=b.product_id
		AND DATE_FORMAT(a.create_time, '%Y-%m-%d %H:%i:%s')= DATE_FORMAT(b.lastVisitTime, '%Y-%m-%d %H:%i:%s')
		INNER JOIN drug_user du
		ON a.virtual_drug_user_id=du.id
		GROUP BY a.virtual_doctor_id, a.product_id


	</select>

	<!-- 获取多个医生的手机号 -->
	<select id="getDoctorTelephoneList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v3_0.DoctorTelephoneResponse">
		SELECT id doctorId, telephone FROM doctor WHERE LEFT(telephone, 1)!=4 AND id IN
		<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
			#{doctorId}
		</foreach>
		  UNION
		  SELECT doctor_id doctorId, telephone FROM doctor_telephone WHERE doctor_id IN
		<foreach collection="doctorIdList" item="doctorId" open="(" close=")" separator=",">
			#{doctorId}
		</foreach>

	</select>

	<insert id="saveTelephoneList">
		INSERT INTO doctor_telephone(doctor_id, telephone)
		VALUES
		<foreach collection ="telephoneList" item="t" separator =",">
			(#{doctorId}, #{t})
		</foreach>

	</insert>


</mapper>