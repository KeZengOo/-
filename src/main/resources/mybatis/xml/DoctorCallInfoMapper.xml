<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nuoxin.virtual.rep.api.mybatis.DoctorCallInfoMapper">

    <select id="getCallInfoStatistics" resultType="com.nuoxin.virtual.rep.api.web.controller.response.work.TodayStatisticsResponseBean"
            parameterType="com.nuoxin.virtual.rep.api.web.controller.request.WorkStationRequestBean">

              select (
                select count(distinct vdci.virtual_doctor_id)
                from virtual_doctor_call_info vdci
                inner join virtual_doctor_call_info_details vdcid
                on vdci.id = vdcid.call_id
                inner join drug_user_doctor dud
                on vdci.virtual_drug_user_id=dud.drug_user_id
                inner join drug_user du
                on du.id = dud.drug_user_id
                inner join product_line pl
                on dud.prod_id=pl.prod_id
                where 1=1
                and vdci.visit_channel=1
                and dud.is_available=1
                <if test="productId != null and productId !=0">
                    and dud.prod_id=#{productId}
                    and vdci.product_id = #{productId}
                </if>

                and du.leader_path like #{leaderPath}
                <!-- and vdcid.status_name='answer' -->
                and vdcid.status_name in ('answer','incall')

                and date_format(vdci.create_time, '%Y-%m-%d')=date_format(NOW(), '%Y-%m-%d')
                ) as callSum,
                (
                select count(distinct vdci.id)
                from virtual_doctor_call_info vdci
                inner join virtual_doctor_call_info_details vdcid
                on vdci.id = vdcid.call_id
                inner join drug_user_doctor dud
                on vdci.virtual_drug_user_id=dud.drug_user_id
                inner join drug_user du
                on du.id = dud.drug_user_id
                inner join product_line pl
                on dud.prod_id=pl.prod_id
                where 1=1
                and dud.is_available=1
                and vdci.visit_channel=1
                <if test="productId!=null and productId !=0">
                    and dud.prod_id=#{productId}
                    and vdci.product_id = #{productId}
                </if>

                and du.leader_path like #{leaderPath}
                <!-- and vdcid.status_name='answer' -->
                and vdcid.status_name in ('answer','incall')
                and date_format(vdci.create_time, '%Y-%m-%d')=date_format(NOW(), '%Y-%m-%d')
                ) as callCount

    </select>


    <select id="getCallInfoTimeStatistics" resultType="com.nuoxin.virtual.rep.api.web.controller.response.work.TodayStatisticsResponseBean"
            parameterType="com.nuoxin.virtual.rep.api.web.controller.request.WorkStationRequestBean">

            <!--select ifnull(sum(vdci.call_time),0) as callTotalTime from virtual_doctor_call_info vdci
            inner join virtual_doctor_call_info_details vdcid
            on vdci.id = vdcid.call_id
            inner join drug_user_doctor dud
            on vdci.virtual_drug_user_id=dud.drug_user_id
            inner join drug_user du
            on du.id = dud.drug_user_id
            inner join product_line pl
            on dud.prod_id=pl.prod_id
            where 1=1
            <if test="productId !=null and productId !=0">
                and dud.prod_id=#{productId}
                and vdci.product_id=#{productId}
            </if>

            and du.leader_path like #{leaderPath}
            and vdcid.status_name='answer'

            and date_format(vdci.create_time, '%Y-%m-%d')=date_format(NOW(), '%Y-%m-%d')-->





        select ifnull(sum(t.call_time),0) callTotalTime  from (
        select distinct vdci.id,vdci.call_time from virtual_doctor_call_info vdci
        inner join virtual_doctor_call_info_details vdcid
        on vdci.id = vdcid.call_id
        inner join drug_user_doctor dud
        on vdci.virtual_drug_user_id=dud.drug_user_id
        inner join drug_user du
        on du.id = dud.drug_user_id
        inner join product_line pl
        on dud.prod_id=pl.prod_id
        where 1=1
        and dud.is_available=1
        and vdci.visit_channel=1
        and dud.prod_id=#{productId}
        and vdci.product_id=#{productId}


        and du.leader_path like #{leaderPath}
        <!-- and vdcid.status_name='answer'-->
        and vdcid.status_name in ('answer','incall')
        and date_format(vdci.create_time, '%Y-%m-%d')=date_format(NOW(), '%Y-%m-%d')

        ) t


    </select>

    <!-- 测试的 -->
    <select id="getCallInfoList" resultType="com.nuoxin.virtual.rep.api.web.controller.response.call.CallInfoResponseBean">
          select id,sin_token sinToken,info_json infoJson from virtual_doctor_call_info
          where visit_channel=1 and call_time > 0 and ( call_url is null or call_url='') order by create_time desc
    </select>

    <update id="updateCallUrl">
        update virtual_doctor_call_info set call_url=#{callUrl} where id = #{id}
    </update>


    <select id="getCallUrlBySigToken" resultType="java.lang.String">
        select call_url from virtual_doctor_call_info where sin_token = #{sigToken}
    </select>

    <!-- 根据sinToken查询电话记录信息 -->
    <select id="getCallInfoBySinToken" resultType="com.nuoxin.virtual.rep.api.web.controller.response.call.CallInfoResponseBean">
        SELECT id, call_url callUrl, call_time callTime, status_name statusName  FROM virtual_doctor_call_info WHERE sin_token = #{sinToken}
    </select>

    <!-- 新增重试的电话记录 -->
    <insert id="addRetryCallInfo">
        INSERT INTO virtual_doctor_call_info(sin_token, is_retry, mobile,status, status_name, call_time, call_url, create_time, type)
        VALUES (#{sinToken}, #{retry}, #{mobile},#{status}, #{statusName}, #{callTime}, #{callUrl}, #{createTime}, #{type})
    </insert>


    <update id="updateCallUrlBySigToken">
        update virtual_doctor_call_info set is_retry=1, call_url = #{callUrl}, call_time=#{callTime}, status_name='answer'
        where sin_token = #{sinToken}
    </update>

    <select id="getDoctorVisitDetailList" resultType="java.util.LinkedHashMap">

        <!-- 2018-09-29 修改前
        SELECT * FROM
        (SELECT DISTINCT t.`id`,IFNULL(t2.`name`,'') drugUserName,IFNULL(date_format(t.`create_time`, '%Y-%m-%d %H:%i:%s'),'')  visitTime,IFNULL(t3.`id`,'') doctorId,IFNULL(t3.`name`,'') doctorName,
        IFNULL(t3.`hospital_name`,'') hospitalName,"电话" visitType,"" shareContent,IFNULL(t1.`visit_result`,'') visitResult,IFNULL(t1.`attitude`,'') attitude,IFNULL(date_format(t1.`next_visit_time`, '%Y-%m-%d %H:%i:%s'),'') nextVisitTime
        ,IFNULL(t4.client_level,'') clientLevel,IFNULL(t5.`hcp_potential`,'') hcpPotential,IFNULL(t5.is_has_drug,'') isHasDrug,IFNULL(t5.`is_target`,'') isTarget,IFNULL(t5.`is_has_ae`,'')  isHasAe
        FROM `virtual_doctor_call_info` t LEFT JOIN `virtual_doctor_call_info_mend` t1 ON t.id=t1.`call_id`
        JOIN drug_user t2 ON t.virtual_drug_user_id=t2.`id`
        JOIN doctor t3 ON t.`virtual_doctor_id`=t3.id
        LEFT JOIN `doctor_virtual` t4 ON t.`virtual_doctor_id`=t4.`doctor_id` AND t.`product_id`=t4.`product_id`
        LEFT JOIN `drug_user_doctor_quate` t5 ON t.`virtual_doctor_id`=t5.`doctor_id` AND t.`product_id`=t5.`product_id` AND t.`virtual_drug_user_id`=t5.`drug_user_id`
        WHERE t.product_id=#{productId}
        <if test="drugUserId!=null">
            and t.virtual_drug_user_id=#{drugUserId}
        </if>
        <if test="startTime!=null">
            and date_format(t.create_time,'%Y-%m-%d')&gt;=#{startTime}
        </if>
        <if test="endTime!=null">
            and date_format(t.create_time,'%Y-%m-%d')&lt;=#{endTime}
        </if>
        <if test="contents!=null and contents.size>0">
            and
            <foreach collection="contents" item="content" open="(" close=")" separator="or">
                t1.visit_result LIKE CONCAT('%',#{content},'%')
            </foreach>
        </if>
        <if test="contents==null or contents.size==0">
            UNION ALL
            SELECT DISTINCT t.`id`,IFNULL(t3.`name`,'') drugUserName,IFNULL(date_format(t.`create_time`, '%Y-%m-%d %H:%i:%s'),'') visitTime,IFNULL(t4.`id`,'') doctorId,IFNULL(t4.`name`,'') doctorName,
            IFNULL(t4.`hospital_name`,'') hospitalName,CASE WHEN share_type=1 THEN "微信" WHEN share_type=2 THEN "短信" WHEN share_type=3 THEN "邮件" else "" END  visitType,
            IFNULL(t2.title,'') shareContent,"" visitResult,"" attitude,"" nextVisitTime
            ,call_dud.clientLevel,IFNULL(t6.`hcp_potential`,'') hcpPotential,IFNULL(t6.is_has_drug,'') isHasDrug,IFNULL(t6.`is_target`,'') isTarget,IFNULL(t6.`is_has_ae`,'')  isHasAe
            FROM `activity_share` t
            JOIN `t_content_product` t1 ON t.`data_id`=t1.`content_id`
            JOIN `activity_info` t2 ON t.`data_id`=t2.`data_id`
            JOIN drug_user t3 ON t.drug_user_id=t3.`id`
            JOIN doctor t4 ON t.`share_person_id`=t4.id
            LEFT JOIN `doctor_virtual` t5 ON t.`share_person_id`=t5.`doctor_id` AND t1.`product_id`=t5.`product_id`
            LEFT JOIN `drug_user_doctor_quate` t6 ON t.`share_person_id`=t6.`doctor_id` AND t1.`product_id`=t6.`product_id` AND t.`drug_user_id`=t6.`drug_user_id`
            WHERE t1.product_id=#{productId}
            <if test="drugUserId!=null">
                 and t.drug_user_id=#{drugUserId}
            </if>
            <if test="startTime!=null">
                and date_format(t.create_time,'%Y-%m-%d')&gt;=#{startTime}
            </if>
            <if test="endTime!=null">
                and date_format(t.create_time,'%Y-%m-%d')&lt;=#{endTime}
            </if>
        </if>
        ) t ORDER BY t.visitTime DESC
        <if test="type==1">
            LIMIT #{currentSize},#{pageSize}
        </if>
        -->



        <!-- 2018-09-29 修改后 -->
        SELECT * FROM (
        SELECT
        vdci.id,call_dud.drugUserName,IFNULL(date_format(vdci.create_time, '%Y-%m-%d %H:%i:%s'),'')  visitTime,call_dud.doctorId,call_dud.doctorName,
        call_dud.hospitalName,
        CASE WHEN vdci.visit_channel=1 THEN "电话" WHEN vdci.visit_channel=2 THEN "微信" WHEN vdci.visit_channel=3 THEN "短信"
        WHEN vdci.visit_channel=4 THEN "邮件"
        WHEN vdci.visit_channel=5 THEN "面谈"
        else "" END visitType,vdci.visit_channel visitChannel,"" shareContent,IFNULL(GROUP_CONCAT(vppvr.visit_result),'') visitResult,IFNULL(vdcim.`attitude`,'') attitude,IFNULL(date_format(vdcim.`next_visit_time`, '%Y-%m-%d %H:%i:%s'),'') nextVisitTime
        ,call_dud.clientLevel,IFNULL(vdcim.`hcp_potential`,'未知') hcpPotential,IFNULL(vdcim.is_has_drug,'未知') isHasDrug,IFNULL(vdcim.`is_target`,'未知') isTarget,IFNULL(vdcim.`is_has_ae`,'未知')  isHasAe
        FROM
        virtual_doctor_call_info vdci
        LEFT JOIN virtual_doctor_call_info_mend vdcim ON vdci.id=vdcim.call_id

        LEFT JOIN virtual_doctor_call_info_result vdcir
        ON vdcim.id=vdcir.mend_id
        LEFT JOIN virtual_product_visit_result vppvr
        ON vdcir.result_id=vppvr.id

        INNER JOIN (
        SELECT DISTINCT
        d.id doctorId,d.`name` doctorName,d.hospital_name hospitalName,IFNULL(dv.client_level,'') clientLevel,du.`name` drugUserName
        FROM
        doctor d
        INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
        INNER JOIN drug_user du ON dud.drug_user_id = du.id
        LEFT JOIN doctor_virtual dv
        ON d.id=dv.doctor_id AND dv.product_id=#{productId}
        WHERE
        dud.is_available = 1

        AND dud.prod_id = #{productId}

        <!--
        <if test="drugUserId!=null">
            and du.id=#{drugUserId}
        </if>
        -->

        <if test="doctorId !=null and doctorId !=0">
            and d.id = #{doctorId}
        </if>

        AND du.id IN
        <foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
            #{drugUserId}
        </foreach>

        ) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
        WHERE
        vdci.product_id=#{productId}

        <if test="visitResultIdList !=null and visitResultIdList.size > 0">
            AND vdcir.result_id IN
            <foreach collection="visitResultIdList" item="visitResultId" open="(" close=")" separator=",">
                #{visitResultId}
            </foreach>
        </if>


        <if test="startTime!=null and startTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &gt;=#{startTime}
        </if>
        <if test="endTime!=null  and endTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &lt;=#{endTime}
        </if>
        <if test="contents!=null and contents.size>0">
            and
            <foreach collection="contents" item="content" open="(" close=")" separator="or">
                vdcim.visit_result LIKE CONCAT('%',#{content},'%')
            </foreach>
        </if>

        GROUP BY vdci.id

        <if test="contents==null or contents.size==0">
            UNION ALL
            SELECT
            a.id,content_dud.drugUserName,IFNULL(date_format(a.`create_time`, '%Y-%m-%d %H:%i:%s'),'') visitTime,content_dud.doctorId,content_dud.doctorName,
            content_dud.hospitalName,'内容分享' visitType,
            6 visitChannel,
            IFNULL(ai.title,'') shareContent,"" visitResult,"" attitude,"" nextVisitTime
            ,content_dud.clientLevel,'未知' hcpPotential,'未知' isHasDrug,'未知' isTarget,'未知'  isHasAe
            FROM
            activity_share a
            INNER JOIN (
            SELECT DISTINCT
            d.id doctorId,d.`name` doctorName,d.hospital_name hospitalName,IFNULL(dv.client_level,'') clientLevel,du.`name` drugUserName
            FROM
            doctor d
            INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
            INNER JOIN drug_user du ON dud.drug_user_id = du.id
            LEFT JOIN doctor_virtual dv
            ON d.id=dv.doctor_id AND dv.product_id=#{productId}
            WHERE
            dud.is_available = 1
            AND dud.prod_id = #{productId}

            <!--
            <if test="drugUserId!=null">
                and du.id=#{drugUserId}
            </if>
            -->

            AND du.id IN
            <foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
                #{drugUserId}
            </foreach>


            <if test="doctorId !=null and doctorId !=0">
                and d.id = #{doctorId}
            </if>


            ) content_dud ON a.share_person_id = content_dud.doctorId
            INNER JOIN activity_info ai ON ai.id=a.data_id
            WHERE
            a.data_id IN (
            SELECT DISTINCT
            tcp.content_id
            FROM
            t_content_product tcp
            INNER JOIN product_line pl ON tcp.product_id = pl.prod_id
            INNER JOIN activity_info ai ON tcp.content_id = ai.id
            WHERE
            tcp.product_id = #{productId}
            )
            <if test="startTime!=null and startTime!=''">
                and date_format(a.create_time,'%Y-%m-%d') &gt;=#{startTime}
            </if>
            <if test="endTime!=null and endTime!=''">
                and date_format(a.create_time,'%Y-%m-%d') &lt;=#{endTime}
            </if>

            GROUP BY a.id

        </if>
        ) b
        WHERE 1=1

        <if test="visitChannel !=null and visitChannel!=0">
            and visitChannel=#{visitChannel}
        </if>


        ORDER BY b.visitTime DESC
        <if test="type==1">
            LIMIT #{currentSize},#{pageSize}
        </if>



    </select>

    <select id="getDoctorVisitDetailListCount" resultType="java.lang.Integer">

        <!-- 2018-09-29 修改前
        SELECT count(*) total FROM
        (SELECT DISTINCT t.`id`
        FROM `virtual_doctor_call_info` t LEFT JOIN `virtual_doctor_call_info_mend` t1 ON t.id=t1.`call_id`
        JOIN drug_user t2 ON t.virtual_drug_user_id=t2.`id`
        JOIN doctor t3 ON t.`virtual_doctor_id`=t3.id
        WHERE t.product_id=#{productId}
        <if test="drugUserId!=null">
            and t.virtual_drug_user_id=#{drugUserId}
        </if>
        <if test="startTime!=null">
            and date_format(t.create_time,'%Y-%m-%d')&gt;=#{startTime}
        </if>
        <if test="endTime!=null">
            and date_format(t.create_time,'%Y-%m-%d')&lt;=#{endTime}
        </if>
        <if test="contents!=null and contents.size>0">
            and
            <foreach collection="contents" item="content" open="(" close=")" separator="or">
                t1.visit_result LIKE CONCAT('%',#{content},'%')
            </foreach>
        </if>
        <if test="contents==null or contents.size==0">
            UNION ALL
            SELECT DISTINCT t.`id`
            FROM `activity_share` t
            JOIN `t_content_product` t1 ON t.`data_id`=t1.`content_id`
            JOIN `activity_info` t2 ON t.`data_id`=t2.`data_id`
            JOIN drug_user t3 ON t.drug_user_id=t3.`id`
            JOIN doctor t4 ON t.`share_person_id`=t4.id
            WHERE t1.product_id=#{productId}
            <if test="drugUserId!=null">
                and t.drug_user_id=#{drugUserId}
            </if>
            <if test="startTime!=null">
                and date_format(t.create_time,'%Y-%m-%d')&gt;=#{startTime}
            </if>
            <if test="endTime!=null">
                and date_format(t.create_time,'%Y-%m-%d')&lt;=#{endTime}
            </if>
        </if>
        ) t
        -->


        <!-- 2018-09-29 修改后 -->
        SELECT COUNT(*) FROM (
        SELECT
        DISTINCT vdci.id, vdci.visit_channel visitChannel
        FROM
        virtual_doctor_call_info vdci
        LEFT JOIN virtual_doctor_call_info_mend vdcim ON vdci.id=vdcim.call_id

        LEFT JOIN virtual_doctor_call_info_result vdcir
        ON vdcim.id=vdcir.mend_id
        LEFT JOIN virtual_product_visit_result vppvr
        ON vdcir.result_id=vppvr.id

        INNER JOIN (
        SELECT DISTINCT
        d.id doctorId,d.`name` doctorName,d.hospital_name hospitalName,IFNULL(dv.client_level,'') clientLevel,du.`name` drugUserName
        FROM
        doctor d
        INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
        INNER JOIN drug_user du ON dud.drug_user_id = du.id
        LEFT JOIN doctor_virtual dv
        ON d.id=dv.doctor_id AND dv.product_id=#{productId}
        WHERE
        dud.is_available = 1

        AND dud.prod_id = #{productId}

        <!--
        <if test="drugUserId!=null">
            and du.id=#{drugUserId}
        </if>
        -->

        <if test="doctorId !=null and doctorId !=0">
            and d.id = #{doctorId}
        </if>

        AND du.id IN
        <foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
            #{drugUserId}
        </foreach>

        ) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
        WHERE
        vdci.product_id=#{productId}

        <if test="visitResultIdList !=null and visitResultIdList.size > 0">
            AND vdcir.result_id IN
            <foreach collection="visitResultIdList" item="visitResultId" open="(" close=")" separator=",">
                #{visitResultId}
            </foreach>
        </if>


        <if test="startTime!=null and startTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &gt;=#{startTime}
        </if>
        <if test="endTime!=null  and endTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &lt;=#{endTime}
        </if>
        <if test="contents!=null and contents.size>0">
            and
            <foreach collection="contents" item="content" open="(" close=")" separator="or">
                vdcim.visit_result LIKE CONCAT('%',#{content},'%')
            </foreach>
        </if>

        <if test="contents==null or contents.size==0">
            UNION ALL
            SELECT
            DISTINCT a.id, 6 visitChannel
            FROM
            activity_share a
            INNER JOIN (
            SELECT DISTINCT
            d.id doctorId,d.`name` doctorName,d.hospital_name hospitalName,IFNULL(dv.client_level,'') clientLevel,du.`name` drugUserName
            FROM
            doctor d
            INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
            INNER JOIN drug_user du ON dud.drug_user_id = du.id
            LEFT JOIN doctor_virtual dv
            ON d.id=dv.doctor_id AND dv.product_id=#{productId}
            WHERE
            dud.is_available = 1
            AND dud.prod_id = #{productId}

            <!--
            <if test="drugUserId!=null">
                and du.id=#{drugUserId}
            </if>
            -->

            AND du.id IN
            <foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
                #{drugUserId}
            </foreach>


            <if test="doctorId !=null and doctorId !=0">
                and d.id = #{doctorId}
            </if>


            ) content_dud ON a.share_person_id = content_dud.doctorId
            INNER JOIN activity_info ai ON ai.id=a.data_id
            WHERE
            a.data_id IN (
            SELECT DISTINCT
            tcp.content_id
            FROM
            t_content_product tcp
            INNER JOIN product_line pl ON tcp.product_id = pl.prod_id
            INNER JOIN activity_info ai ON tcp.content_id = ai.id
            WHERE
            tcp.product_id = #{productId}
            )
            <if test="startTime!=null and startTime!=''">
                and date_format(a.create_time,'%Y-%m-%d') &gt;=#{startTime}
            </if>
            <if test="endTime!=null and endTime!=''">
                and date_format(a.create_time,'%Y-%m-%d') &lt;=#{endTime}
            </if>

        </if>
        ) b
        WHERE 1=1

        <if test="visitChannel !=null and visitChannel!=0">
            and visitChannel=#{visitChannel}
        </if>


    </select>
    
    <!-- 得到电话统计 -->
    <select id="getCallTime" resultType="com.nuoxin.virtual.rep.api.web.controller.response.v2_5.CallTimeResponseBean">

        SELECT
        SUM(call_time) callTime,
        COUNT(*) callCount
        FROM virtual_doctor_call_info WHERE status_name='answer' AND  id IN (

        SELECT
        DISTINCT vdci.id
        FROM
        virtual_doctor_call_info vdci
        LEFT JOIN virtual_doctor_call_info_mend vdcim ON vdci.id=vdcim.call_id

        <if test="visitResultIdList !=null and visitResultIdList.size > 0">
            LEFT JOIN virtual_doctor_call_info_result vdcir
            ON vdcim.id=vdcir.mend_id
        </if>


        INNER JOIN (
        SELECT DISTINCT
        d.id doctorId,d.`name` doctorName,d.hospital_name hospitalName,IFNULL(dv.client_level,'') clientLevel,du.`name`
        drugUserName
        FROM
        doctor d
        INNER JOIN drug_user_doctor dud ON d.id = dud.doctor_id
        INNER JOIN drug_user du ON dud.drug_user_id = du.id
        LEFT JOIN doctor_virtual dv
        ON d.id=dv.doctor_id AND dv.product_id=#{productId}
        WHERE
        dud.is_available = 1

        <if test="doctorId !=null and doctorId !=0">
            and d.id = #{doctorId}
        </if>
        AND dud.prod_id = #{productId}

        AND du.id IN
        <foreach collection="drugUserIds" item="drugUserId" open="(" close=")" separator=",">
            #{drugUserId}
        </foreach>

        ) call_dud ON vdci.virtual_doctor_id = call_dud.doctorId
        WHERE
        vdci.product_id=#{productId}
        AND vdci.visit_channel=1

        <if test="visitResultIdList !=null and visitResultIdList.size > 0">
            AND vdcir.result_id IN
            <foreach collection="visitResultIdList" item="visitResultId" open="(" close=")" separator=",">
                #{visitResultId}
            </foreach>
        </if>


        <if test="startTime!=null and startTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &gt;=#{startTime}
        </if>
        <if test="endTime!=null  and endTime!=''">
            and date_format(vdci.create_time,'%Y-%m-%d') &lt;=#{endTime}
        </if>

        )
    </select>
    

    <select id="lastVisitTime" resultType="java.util.Date">
        SELECT MAX(t.create_time) lastVisitTime FROM virtual_doctor_call_info t
        WHERE visit_channel=1 AND virtual_drug_user_id =#{drugUserId} AND virtual_doctor_id=#{doctorId}
    </select>

</mapper>